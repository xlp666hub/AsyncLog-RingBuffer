# **Cè¯­è¨€å®æˆ˜ï¼šæ‰‹æ“é«˜å¹¶å‘å¼‚æ­¥æ—¥å¿—åº“ï¼ˆåŸºäº Ring Buffer + ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ï¼‰**

# 1. ä¸ºä»€ä¹ˆ `printf` ä¸å¤Ÿç”¨ï¼Ÿ

åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œå°¤å…¶æ˜¯åµŒå…¥å¼è®¾å¤‡ã€å®æ—¶ç³»ç»Ÿæˆ–é«˜å¹¶å‘æœåŠ¡ç«¯ç¨‹åºé‡Œï¼Œå¾ˆå¤šäººä¸€å¼€å§‹éƒ½ä¹ æƒ¯ç›´æ¥ç”¨ printfã€fprintf æˆ– write æŠŠæ—¥å¿—æ‰“åˆ°ä¸²å£ã€æ–‡ä»¶ã€Flashã€‚è¿™ç§åšæ³•åœ¨demoé˜¶æ®µæ²¡ä»€ä¹ˆé—®é¢˜ï¼Œä½†ä¸€æ—¦ä¸Šäº†ç”Ÿäº§ç¯å¢ƒæ‰å‘ç°è¿™ç©æ„å„¿æ˜¯ä¸ªéšå½¢çš„æ€§èƒ½æ€æ‰‹ã€‚

æˆ‘ä¸‹é¢åˆ—ä¸¾ä¸€ä¸‹å¸¸è§çš„å‡ ä¸ª**è‡´å‘½é—®é¢˜**ï¼ˆæœ¬äººä¹Ÿä¸å¹¸è¸©åˆ°è¿‡ï¼‰ï¼š

1. åŒæ­¥é˜»å¡ï¼šåƒ`write`è¿™æ ·çš„åº•å±‚æ¥å£æ˜¯é˜»å¡çš„ï¼Œè€Œç£ç›˜ / Flash / ä¸²å£é€šå¸¸æ˜¯æ¯”è¾ƒæ…¢çš„ï¼ˆFlash æ“¦é™¤ç”šè‡³èƒ½åˆ°å‡ ç™¾æ¯«ç§’ï¼‰ï¼Œä¸šåŠ¡çº¿ç¨‹å°±åªèƒ½å¹²ç­‰ç€ã€‚

   æˆ‘ä¹‹å‰å†™äº†ä¸ªdemoå®æµ‹äº†ä¸€ä¸‹ï¼Œç›´æ¥å†™å…¥ 2000 æ¡æ—¥å¿—è€—æ—¶ **7ç§’**ï¼Œè€Œä½¿ç”¨å¼‚æ­¥æ—¥å¿—ä»…éœ€ **0.02ç§’**ï¼Œæ€§èƒ½å·®è·è¾¾ **300å€**ã€‚

2. çº¿ç¨‹ä¸­æ–­é—®é¢˜ï¼šå¤šä»»åŠ¡æˆ–ä¸­æ–­é‡ŒåŒæ—¶ printfï¼Œæ²¡æœ‰é”çš„è¯æ—¥å¿—ç«‹åˆ»èŠ±å±ï¼ˆAçº¿ç¨‹æ‰“å°ä¸€åŠï¼ŒBçº¿ç¨‹æ’è¿›æ¥äº†ï¼‰ï¼Œå¯¼è‡´æ—¥å¿—æ²¡æ³•çœ‹ï¼Œè€ŒåŠ é”åˆä¼šå¸¦æ¥æ–°çš„æ€§èƒ½å’Œæ­»é”é£é™©ã€‚

3. ç¼“å­˜åˆ·æ–°ç­–ç•¥å¤±æ§ï¼š`printf` é»˜è®¤**è¡Œç¼“å­˜**ï¼ˆé‡åˆ° \n æˆ–ç¼“å†²åŒºæ»¡æ‰åˆ·ï¼‰ï¼Œåœ¨åµŒå…¥å¼é‡Œç»å¸¸å¿˜è®° `fflush`ï¼Œåœ¨åµŒå…¥å¼ç³»ç»Ÿå´©æºƒæˆ–æ–­ç”µçš„ç¬é—´ï¼Œç¼“å†²åŒºé‡Œé‡è¦çš„æ•°æ®å¾€å¾€è¿˜æ²¡æ¥å¾—åŠåˆ·å…¥ç£ç›˜å°±ä¸¢å¤±äº†**å¯¼è‡´æ—¥å¿—ä¸¢å¤±**éƒ½ä¸çŸ¥é“ã€‚

4. CPU å ç”¨ç‡çˆ†ç‚¸ï¼šé«˜é¢‘ç‡æ‰“æ—¥å¿—æ—¶ï¼ŒCPU å¤§éƒ¨åˆ†æ—¶é—´éƒ½åœ¨ç­‰ I/Oï¼Œè€Œä¸æ˜¯å¹²æ­£äº‹ã€‚

é‚£ä¹ˆæ­£ç¡®çš„æ“ä½œåº”è¯¥æ˜¯æ€æ ·çš„å‘¢ï¼Ÿ

æˆ‘ä»¬è¦æŠŠè®°å½•æ—¥å¿—å’Œå†™å…¥ç£ç›˜å½»åº•è§£è€¦ã€‚**ä¸šåŠ¡çº¿ç¨‹**åªè´Ÿè´£æŠŠæ—¥å¿—æ‰”è¿›ä¸€ä¸ªå†…å­˜ç¼“å†²åŒºï¼ˆå¤§æ¦‚å‡ å¾®ç§’ï¼‰ï¼Œç„¶åç«‹åˆ»è¿”å›ç»§ç»­å¹²æ´»ã€‚ ç”±ä¸€ä¸ªç‹¬ç«‹çš„**åå°çº¿ç¨‹**æ…¢æ…¢æŠŠç¼“å†²åŒºå†…å®¹åˆ·åˆ°ç£ç›˜/Flash/ä¸²å£å»ã€‚è¿™å°±æ˜¯ç»å…¸çš„ â€œ ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ â€ å’Œç¯å½¢ç¼“å†²åŒºçš„ç»„åˆã€‚è¿™ä¹Ÿæ˜¯å¾ˆå¤šå·¥ä¸šçº§æ—¥å¿—åº“çš„åº•å±‚åŸç†ã€‚

# 2. ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹

ä¸ºäº†è§£å†³ä¸Šé¢æåˆ°çš„åŒæ­¥é˜»å¡é—®é¢˜ï¼Œæˆ‘ä»¬ä¸èƒ½è®©ä¸šåŠ¡çº¿ç¨‹ç›´æ¥å»â€œç¢°â€ç£ç›˜ã€‚æˆ‘ä»¬éœ€è¦å¼•å…¥ä¸€ä¸ªä¸­é—´å±‚ï¼Œå°†**äº§ç”Ÿæ—¥å¿—**å’Œ**å†™å…¥ç£ç›˜**è¿™ä¸¤ä¸ªåŠ¨ä½œå½»åº•å‰¥ç¦»ã€‚è¿™æ­£æ˜¯è®¡ç®—æœºç§‘å­¦ä¸­ç»å…¸çš„**ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹**çš„æœ€ä½³åº”ç”¨åœºæ™¯ã€‚

## 2.1 ç³»ç»Ÿæ¶æ„

ä¸‹é¢è¦ä»‹ç»çš„è¿™ä¸ªæ¶æ„ä¹Ÿå°±æ˜¯**ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹**è¿™ä¸ªåå­—çš„ç”±æ¥ã€‚

æˆ‘ä»¬å¯ä»¥æŠŠæ•´ä¸ªæ—¥å¿—ç³»ç»Ÿçœ‹æˆä¸€ä¸ªç¹å¿™çš„é¤å…çš„å¨æˆ¿ã€‚å¯èƒ½æœ‰äººä¼šæƒ³â€œé‚£ç”Ÿäº§è€…å°±æ˜¯å¨å¸ˆï¼Œæ¶ˆè´¹è€…å°±æ˜¯é¡¾å®¢å‘—â€ï¼Œæˆ‘è®¤ä¸ºè¿™ä¸ªæƒ³æ³•æ—¢åˆç†åˆä¸åˆç†ï¼Œåˆç†æ˜¯å› ä¸ºè¿™ä¸ªæƒ³æ³•æ˜¯ç¬¦åˆæˆ‘ä»¬çš„å¸¸è¯†çš„ï¼Œä¸åˆç†æ˜¯å› ä¸ºåœ¨æ—¥å¿—ç³»ç»Ÿè¿™ä¸ªç¯å¢ƒä¸‹ï¼Œæ˜¯æœ‰ç‰¹æ®Šæƒ…å†µå­˜åœ¨çš„ï¼Œåé¢ä¼šè§£é‡Šã€‚åœ¨è¿™é‡Œï¼Œå…¶å®ç”Ÿäº§è€…ç›¸å½“äºæœåŠ¡å‘˜ï¼Œæ¶ˆè´¹è€…ç›¸å½“äºå¨å¸ˆï¼Œè€Œä»–ä»¬ä¹‹é—´æœ‰ä¸€ä¸ªçª—å£ï¼Œå°±æ˜¯ç¼“å†²åŒºï¼ˆæ”¾èœå•ï¼‰ã€‚æ‰€ä»¥æ•´ä¸ªè¿‡ç¨‹å…¶å®å°±æ˜¯æœåŠ¡å‘˜å»ç»™å¤§é‡çš„å®¢äººç‚¹èœï¼Œç„¶åæŠŠèœå•æ”¾åœ¨çª—å£ï¼Œå¨å¸ˆä»çª—å£æ‹¿èœå•ï¼Œç„¶ååšé¥­ï¼Œåšé¥­å¯ä»¥ç±»æ¯”ä¸ºå†™ç£ç›˜ã€‚åˆ°è¿™é‡Œå°±ç»“æŸï¼Œè‡³å°‘åœ¨ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹ä¸‹ï¼Œè¿™ä¸ªåœºæ™¯å·²ç»å¾ˆå®Œå–„äº†ã€‚æ‰€ä»¥å‰é¢é‚£ä¸ªæŠŠé¡¾å®¢å½“æˆæ¶ˆè´¹è€…çš„æƒ³æ³•æœ‰ç‚¹ä¸å¤ªåˆé€‚ï¼Œå¦‚æœè¿™æ ·ç†è§£å°±ç›¸å½“äºä¸€ä¸ªé¡¾å®¢åé‚£ä¸€ç›´åƒåƒåƒ......ï¼ˆèƒƒå£å¤§çš„è¯å…¶å®ä¹Ÿä¸æ˜¯ä¸è¡ŒğŸŒï¼‰

å¯èƒ½æœ‰çš„æœ‹å‹è¿˜æ˜¯è§‰å¾—ä¸å¤Ÿå½¢è±¡ï¼Œä¸‹é¢æˆ‘æ”¾ä¸€å¼ å›¾å¤§å®¶å¯ä»¥å‚è€ƒä¸€ä¸‹ï¼šï¼ˆçº¯æ‰‹ç”»çš„ï¼Œæ„Ÿè§‰ç”»çš„ä¸é”™çš„æœ‹å‹ç‚¹èµåŠ å…³æ³¨ï¼Œä¸æƒ³çš„è¯å°±ç®—äº†ğŸ˜Šï¼‰

![ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ç³»ç»Ÿæ¶æ„å›¾.png](C:\Users\xlp\Desktop\å›¾ç‰‡å­˜æ”¾\ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ç³»ç»Ÿæ¶æ„å›¾.png.png)

å¯èƒ½æœ‰ç»†å¿ƒçš„æœ‹å‹æ³¨æ„åˆ°äº†ï¼Œæˆ‘åœ¨å›¾ç‰‡ä¸­ç”Ÿäº§è€…ç”¨çš„Producersï¼Œè€Œæ¶ˆè´¹è€…å´ç”¨çš„Consumerï¼Œä»–ä»¬ä¸€ä¸ªæ˜¯å¤æ•°ï¼Œä¸€ä¸ªæ˜¯å•æ•°ï¼Œæ„æ€æ˜¯æœ‰å¤šä¸ªç”Ÿäº§è€…è€Œåªæœ‰ä¸€ä¸ªæ¶ˆè´¹è€…å—ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ã€‚è¿™ä¸ªæ¨¡å‹çš„åç§°æ˜¯**MPSC (Multi-Producer Single-Consumer) ï¼Œè¿™æ˜¯é«˜æ€§èƒ½æ—¥å¿—ç³»ç»Ÿçš„æ ‡å‡†æ¶æ„ã€‚**

ä¸ºä»€ä¹ˆæ¶ˆè´¹è€…åªæœ‰ä¸€ä¸ªå‘¢ï¼Ÿå¤šä¸ªæ¶ˆè´¹è€…ä¼šæ€ä¹ˆæ ·å‘¢ï¼Ÿ

1. æ—¥å¿—æ–‡ä»¶é€šå¸¸æ˜¯ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼ˆlog.txtï¼‰ã€‚å¦‚æœä½ æäº† 5 ä¸ªæ¶ˆè´¹è€…çº¿ç¨‹åŒæ—¶å¾€ä¸€ä¸ªæ–‡ä»¶é‡Œå†™ï¼Œä½ éœ€è¦åŠ å¾ˆé‡çš„é”æ¥é˜²æ­¢æ•°æ®é”™ä¹±ï¼ˆæ¯”å¦‚çº¿ç¨‹ A å†™äº†ä¸€åŠâ€œError...â€ï¼Œçº¿ç¨‹ B æ’è¿›æ¥å†™äº†â€œWarning...â€ï¼‰ã€‚æ—¢ç„¶æœ€ç»ˆéƒ½è¦**åŠ é”æ’é˜Ÿå†™æ–‡ä»¶**ï¼Œé‚£å¤šæå‡ ä¸ªæ¶ˆè´¹è€…çº¿ç¨‹ä¸ä»…æ²¡å˜å¿«ï¼Œåè€Œå¢åŠ äº†**ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å¼€é”€**ï¼Œè¿˜ä¸å¦‚å°±ä¸€ä¸ªçº¿ç¨‹ä¸“é—¨æ’é˜Ÿå†™ã€‚
2. å¯¹äºæœºæ¢°ç¡¬ç›˜æˆ–åµŒå…¥å¼ Flashï¼Œ**é¡ºåºå†™å…¥**æ˜¯æœ€å¿«çš„ã€‚å¦‚æœæœ‰å¤šä¸ªæ¶ˆè´¹è€…å¹¶å‘å†™ï¼Œç£å¤´ï¼ˆæˆ– Flash ä¸»æ§ï¼‰å¯èƒ½éœ€è¦è·³æ¥è·³å»ï¼Œæ€§èƒ½åè€Œä¼šä¸‹é™ã€‚
3. ä¸€ä¸ªæ¶ˆè´¹è€…çº¿ç¨‹ç»´æŠ¤ä¸€ä¸ªæ–‡ä»¶å¥æŸ„ï¼Œé€»è¾‘æ¸…æ™°ï¼Œä¸å®¹æ˜“å‡º Bugã€‚

å› æ­¤ï¼Œå¯¹äºæ—¥å¿—è½ç›˜è¿™ç§**I/Oå¯†é›†å‹**çš„ä»»åŠ¡ï¼Œå•æ¶ˆè´¹è€…æ˜¯æœ€é«˜æ•ˆçš„é€‰æ‹©ã€‚

è¿˜æœ‰çš„æœ‹å‹å¯èƒ½ä¼šé—®ï¼Œä½ ç¬¬ä¸€ç« æ˜æ˜å†™äº†å¼‚æ­¥æ—¥å¿—å¿«ï¼ŒåŒæ­¥é˜»å¡æ˜¯è‡´å‘½é—®é¢˜ï¼Œæ€ä¹ˆä¸Šé¢çš„æ¶æ„å›¾åˆè¯´å®ç°äº†çº¿ç¨‹åŒæ­¥å‘¢ï¼Ÿè¿™ä¸æ˜¯å·¦è„‘æ”»å‡»å³è„‘å—ï¼Ÿå•Šï¼Œè¿™é‡Œç¡®å®æ¯”è¾ƒç»•ï¼Œæˆ‘æœ‰æ—¶ä¹Ÿå¾—æƒ³å¥½ä¹…æ‰èƒ½æƒ³é€šã€‚ä¸‹é¢æˆ‘ä»¬è¯¦ç»†æ‹†è§£ä¸€ä¸‹ï¼š

1. åœ¨å®è§‚å±‚é¢ï¼šä¸šåŠ¡æµç¨‹æ˜¯å¼‚æ­¥çš„

   è¿™é‡Œçš„å¼‚æ­¥æè¿°çš„æ˜¯ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¹‹é—´çš„åä½œå…³ç³»ã€‚

   åŒæ­¥æ—¥å¿—ï¼ˆå­˜åœ¨ç¼ºé™·ï¼‰ï¼šä¸šåŠ¡çº¿ç¨‹è¯´ï¼šâ€œæˆ‘è¦å†™æ—¥å¿—â€ï¼Œç„¶åå°±åœ¨é‚£**æ­»ç­‰**ï¼Œç›´åˆ°ç£ç›˜å†™å®Œæ‰èµ°ã€‚è¿™å«â€œåŒæ­¥é˜»å¡â€ã€‚

   å¼‚æ­¥æ—¥å¿—ï¼šä¸šåŠ¡çº¿ç¨‹è¯´ï¼šâ€œæˆ‘è¦å†™æ—¥å¿—â€ï¼ŒæŠŠæ•°æ®æ‰”è¿›ç¼“å†²åŒºï¼Œ**è½¬èº«å°±èµ°**ï¼Œå»å¹²åˆ«çš„äº‹äº†ã€‚å†™ç£ç›˜çš„äº‹ç•™ç»™åå°æ…¢æ…¢åšã€‚è¿™å«â€œå¼‚æ­¥éé˜»å¡â€ã€‚

   å› ä¸ºä¸šåŠ¡çº¿ç¨‹ä¸éœ€è¦ç­‰ I/Oï¼Œæ‰€ä»¥æˆ‘ä»¬ç§°ä¹‹ä¸º**å¼‚æ­¥æ—¥å¿—ç³»ç»Ÿ**ã€‚è¿™æ˜¯æ€§èƒ½å¤§å¹…åº¦æå‡çš„åŸå› ã€‚

2. åœ¨å¾®è§‚å±‚é¢ï¼šå†…å­˜è®¿é—®æ˜¯éœ€è¦åŒæ­¥çš„

   è¿™é‡Œçš„åŒæ­¥æè¿°çš„æ˜¯ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®åŒä¸€å—å†…å­˜æ—¶çš„å®‰å…¨è§„åˆ™ã€‚

   å¦‚æœä¸šåŠ¡çº¿ç¨‹æ­£åœ¨å¾€ `Buffer[0]` å†™æ•°æ®ï¼Œè¿˜æ²¡å†™å®Œï¼Œåå°çº¿ç¨‹çªç„¶è·‘è¿‡æ¥è¦æŠŠ `Buffer[5]` è¯»èµ°ã€‚è¿™å°±ä¹±å¥—äº†ã€‚

   æˆ‘ä»¬éœ€è¦ä¸€ç§æœºåˆ¶ï¼Œè®©ä»–ä»¬åè°ƒä¸€ä¸‹ï¼šâ€œæˆ‘è¦å†™äº†ï¼Œä½ å…ˆåˆ«åŠ¨â€ï¼ˆäº’æ–¥é”ï¼‰ï¼Œâ€œæˆ‘å†™å®Œäº†ï¼Œè¯¥ä½ è¯»äº†â€ï¼ˆæ¡ä»¶å˜é‡ï¼‰ã€‚

   è¿™ç§ä¸ºäº†ä¿è¯æ•°æ®å®‰å…¨ã€ä¸æ‰“æ¶çš„åè°ƒæœºåˆ¶ï¼Œåœ¨æ“ä½œç³»ç»Ÿé‡Œå«**çº¿ç¨‹åŒæ­¥**ã€‚

   

ä¸¾ä¸€ä¸ªç”Ÿæ´»ä¸­çš„ä¾‹å­æ¥æ¯”å–»ä¸€ä¸‹ï¼š

æˆ‘ä»¬æŠŠä¸šåŠ¡çº¿ç¨‹çœ‹ä½œæœåŠ¡å‘˜ï¼ŒæŠŠ`Ring buffer`çœ‹ä½œçª—å£çš„èœå•é’‰ï¼ˆå›ºå®šèœå•ï¼‰ï¼ŒæŠŠæ—¥å¿—çº¿ç¨‹çœ‹ä½œå¨å¸ˆã€‚è¿™é‡Œå…ˆç®€å•æä¸€ä¸‹ï¼Œä¸ºä»€ä¹ˆæŠŠ`Ring Buffer`çœ‹ä½œèœå•é’‰ï¼Œå› ä¸ºæˆ‘ä»¬çš„ç¯å½¢ç¼“å†²åŒº`Ring Buffer`æ­£æ˜¯ä¸€ä¸ª`malloc`å¾—æ¥çš„å·¨å¤§æ•°ç»„ï¼Œè¿™ä¸ªæ•°ç»„**å¤§å°æ˜¯å›ºå®šçš„**ï¼Œæ­£å¦‚èœå•é’‰åªæœ‰ä¸€ä¸ªï¼Œèœå•åªèƒ½æŒ‰é¡ºåºä¸€ä¸ªä¸€ä¸ªæ’ï¼Œèƒ½æ’çš„èœå•æ•°é‡ä¹Ÿæ˜¯æœ‰é™çš„ï¼Œè¿™ä¸ªåé¢è¿˜ä¼šè¯¦ç»†ä»‹ç»ï¼Œå…ˆå›å½’ä¸»é¢˜ã€‚

åœ¨è¿™ä¸ªåœºæ™¯ä¸‹ç†è§£å°±å®¹æ˜“å¤šäº†ã€‚

å¼‚æ­¥ï¼šæœåŠ¡å‘˜å†™å¥½èœå•ï¼Œå¾€å§å°ä¸Šä¸€æ’ï¼Œè½¬èº«å°±å»æ‹›å‘¼ä¸‹ä¸€æ¡Œå®¢äººäº†**ï¼ˆå¼‚æ­¥ï¼‰**ï¼Œä»–ä¸éœ€è¦ç«™åœ¨å¨æˆ¿é—¨å£ç­‰ç€å¨å¸ˆæŠŠèœç‚’å¥½ï¼ˆåŒæ­¥ï¼‰ã€‚è¿™å°±æ˜¯æ•ˆç‡é«˜çš„åŸå› ã€‚

çº¿ç¨‹åŒæ­¥ï¼šå§å°åªæœ‰ä¸€ä¸ªï¼Œèœå•é’‰åªæœ‰ä¸€ä¸ªã€‚å¦‚æœæœåŠ¡å‘˜æ­£åœ¨å¾€ä¸Šæ’èœå•ï¼Œå¨å¸ˆæ­£å¥½ä¼¸æ‰‹å»æ‹”èœå•ï¼Œä¸¤äººçš„æ‰‹å°±ä¼šæ’åœ¨ä¸€èµ·ï¼ˆç–¼ï¼‰ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ä¸ªè§„åˆ™ï¼ˆäº’æ–¥é”ï¼‰ï¼š**å½“ä¸€ä¸ªäººæ‰‹åœ¨æ¥è§¦èœå•é’‰æ—¶ï¼Œå¦ä¸€ä¸ªäººå¿…é¡»åœ¨æ—è¾¹ç­‰ç€ã€‚**è¿™å°±æ˜¯**çº¿ç¨‹åŒæ­¥**ï¼Œå¹¶ä¸æ˜¯è¯´æˆ‘ä»¬è¦ä¸€èµ·åŠ¨ä½œï¼Œè€Œæ˜¯æˆ‘ä»¬è¦**åè°ƒå¥½é¡ºåºï¼Œä¸è¦æ‰“æ¶**ã€‚

## 2.2 æ ¸å¿ƒè§’è‰²å®šä¹‰

åœ¨è¿™ä¸ªæ¨¡å‹ä¸­ï¼Œæ¯ä¸ªè§’è‰²éƒ½æœ‰è‡ªå·±çš„èŒè´£ï¼š

1. ç”Ÿäº§è€…ï¼š

   ç³»ç»Ÿä¸­çš„ä¸šåŠ¡é€»è¾‘çº¿ç¨‹ï¼ˆå¦‚ä¼ æ„Ÿå™¨ä¿¡æ¯é‡‡é›†ï¼‰ï¼Œå®ƒè°ƒç”¨ `log_push` æ¥å£ï¼Œå°†æ ¼å¼åŒ–å¥½çš„æ—¥å¿—å­—ç¬¦ä¸²**å†™å…¥ç¼“å†²åŒº**ã€‚å¦‚æœç¼“å†²åŒºæ²¡æ»¡ï¼Œå†™å…¥åŠ¨ä½œå‡ ä¹æ˜¯ç¬æ—¶çš„ï¼Œå¦‚æœæ»¡äº†ï¼Œå¯ä»¥é€‰æ‹©ä¸¢å¼ƒæˆ–çŸ­æš‚ç­‰å¾…ï¼ˆè¿™å–å†³äºç­–ç•¥ï¼‰ã€‚

2. ç¯å½¢ç¼“å†²åŒºï¼š

   ä¸€æ®µå›ºå®šå¤§å°çš„å†…å­˜ç©ºé—´ã€‚ä½œä¸ºâ€œè“„æ°´æ± â€ï¼Œå¹³æ»‘ä¸šåŠ¡çº¿ç¨‹çš„æµé‡æ³¢å³°ã€‚ä½¿ç”¨æ•°ç»„æ¨¡æ‹Ÿç¯å½¢é˜Ÿåˆ—ï¼Œé¿å…é¢‘ç¹çš„å†…å­˜ç”³è¯·ä¸é‡Šæ”¾ã€‚

3. æ¶ˆè´¹è€…ï¼š

   ä¸€ä¸ªç‹¬ç«‹çš„åå°å®ˆæŠ¤çº¿ç¨‹ã€‚æ­»å¾ªç¯æ£€æŸ¥ç¼“å†²åŒºã€‚æœ‰æ•°æ®å°±å–å‡ºï¼Œå†™å…¥æ–‡ä»¶ `write`ï¼Œæ²¡æ•°æ®å°±æŒ‚èµ· `wait`ï¼ŒèŠ‚çœ CPU èµ„æºã€‚è™½ç„¶å®ƒå†™ç£ç›˜æ…¢ï¼Œä½†å®ƒä¸€ç›´åœ¨åå°é»˜é»˜å·¥ä½œï¼Œ**ä¸å½±å“å‰å°ä¸šåŠ¡**ã€‚

## 2.3 ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ

è§£è€¦ï¼šè¿™æ ·è®¾è®¡å¯ä»¥**è®©ä¸šåŠ¡é€»è¾‘ä¸å†ä¾èµ–ç£ç›˜ I/O çš„é€Ÿåº¦**ã€‚å“ªæ€•ç£ç›˜çªç„¶å¡é¡¿äº† 1 ç§’ï¼Œä¸šåŠ¡çº¿ç¨‹ä¾ç„¶å¯ä»¥æµç•…è¿è¡Œï¼Œåªè¦ç¼“å†²åŒºæ²¡æ»¡ã€‚

å‰Šå³°å¡«è°·ï¼šåœ¨æŸä¸€ç¬é—´ï¼Œæ—¥å¿—é‡å¯èƒ½**ç¬é—´çˆ†å‘**ã€‚ç¼“å†²åŒºå¯ä»¥**æš‚æ—¶å…œä½**è¿™äº›æ•°æ®ï¼Œåå°çº¿ç¨‹å†æ…¢æ…¢æ¶ˆåŒ–ã€‚å¦‚æœæ²¡æœ‰ç¼“å†²åŒºï¼Œè¿™ç§ç¬é—´çš„å¤§é‡ I/O è¯·æ±‚å¯èƒ½ä¼šç›´æ¥æŠŠç³»ç»Ÿæ‹–å®ã€‚

æ‰¹é‡å†™å…¥ï¼šè¿™é‡Œè¦å…ˆæä¸€å˜´ï¼Œæœ¬é¡¹ç›®æ¼”ç¤ºçš„æ˜¯åŸºç¡€å¼‚æ­¥å†™å…¥ï¼Œæ²¡æœ‰é‡‡ç”¨æ‰¹é‡å†™å…¥ã€‚å¦‚æœåœ¨ç”Ÿäº§ç¯å¢ƒä¸­é…åˆ**æ‰¹é‡å†™å…¥**ï¼ˆæ”’å¤Ÿ 4KB å†è½ç›˜ï¼‰ï¼Œæ€§èƒ½è¿˜èƒ½è¿›ä¸€æ­¥å‹æ¦¨ï¼Œè¿™ä¹Ÿæ˜¯ 300 å€å·®è·çš„æ¥æºä¹‹ä¸€ã€‚æ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥è‡ªå·±å®ç°ä¸€ä¸‹æ‰¹é‡å†™å…¥ï¼Œçœ‹çœ‹æ€§èƒ½å·®è·ç›¸æ¯”æ¯æ¡æ—¥å¿—å†™ä¸€æ¬¡æœ‰å¤šå¤§ã€‚åœ¨è¿›é˜¶ä¼˜åŒ–ä¸­ï¼Œæ¶ˆè´¹è€…å¯ä»¥**ä¸€æ¬¡ç§¯æ”’ 4KB æ•°æ®å†ä¸€æ¬¡æ€§å†™å…¥ç£ç›˜**ï¼Œè¿›ä¸€æ­¥å‡å°‘ç³»ç»Ÿè°ƒç”¨æ¬¡æ•°ï¼Œå»¶é•¿ Flash å¯¿å‘½ã€‚

# 3. æ•°æ®ç»“æ„é€‰å‹ï¼šä¸ºä½•æŠ›å¼ƒé“¾è¡¨ï¼Ÿ

åœ¨è®¾è®¡æ—¥å¿—ç¼“å†²åŒºçš„å­˜å‚¨ç»“æ„æ—¶ï¼Œæœ‰ä¸¤ç§æ•°æ®ç»“æ„å¯ä»¥ä¾›æˆ‘ä»¬æŒ‘é€‰ï¼š

1. é“¾è¡¨ï¼šåŠ¨æ€å¢é•¿ï¼Œç†è®ºä¸Šæ— é™å¤§ã€‚
2. ç¯å½¢ç¼“å†²åŒºï¼šåŸºäºå®šé•¿æ•°ç»„ï¼Œå¾ªç¯ä½¿ç”¨ã€‚

åˆå­¦è€…å¾€å¾€**å–œæ¬¢ç”¨é“¾è¡¨**ï¼Œå› ä¸ºç®€å•ä¸”ä¸éœ€è¦è€ƒè™‘å†…å­˜å æ»¡çš„æƒ…å†µã€‚ä½†åœ¨**é«˜æ€§èƒ½ã€é«˜å¹¶å‘ã€é•¿æœŸè¿è¡Œ**çš„åµŒå…¥å¼/æœåŠ¡ç«¯åœºæ™¯ä¸‹ï¼Œé“¾è¡¨æœ‰ç€è‡´å‘½çš„ç¼ºé™·ã€‚

## 3.1 é“¾è¡¨çš„ä¸‰å¤§ç¼ºé™·

æ—¥å¿—ç³»ç»Ÿä¸€èˆ¬æ˜¯è¦é•¿æœŸè¿è¡Œçš„ï¼Œé‡‡ç”¨é“¾è¡¨çš„æ—¥å¿—ç³»ç»Ÿåœ¨å‹æµ‹å’Œé•¿æœŸè¿è¡Œä¸‹é€šå¸¸ä¼šæš´éœ²ä¸‹é¢å‡ ä¸ªé—®é¢˜ï¼š

### 3.1.1 å†…å­˜ç¢ç‰‡åŒ–

æ¯å½“æœ‰æ–°æ—¥å¿—äº§ç”Ÿï¼Œéƒ½éœ€è¦è°ƒç”¨ `malloc` åˆ†é…ä¸€ä¸ªå°èŠ‚ç‚¹ï¼Œæ¶ˆè´¹åè°ƒç”¨ freeé‡Šæ”¾å†…å­˜ã€‚ä½†åœ¨é«˜é¢‘æ—¥å¿—åœºæ™¯ä¸‹ï¼ˆå¦‚æ¯ç§’ 1000 æ¬¡ï¼‰ï¼Œé¢‘ç¹çš„ç”³è¯·é‡Šæ”¾ä¼šå°†**å †å†…å­˜ç¢ç‰‡åŒ–**ã€‚åœ¨åµŒå…¥å¼è®¾å¤‡é•¿æœŸè¿è¡Œçš„æ¡ä»¶ä¸‹ï¼ˆ7x24å°æ—¶ï¼‰ï¼Œææ˜“å¯¼è‡´ **OOM (Out Of Memory)**ï¼Œå³ä½¿å‰©ä½™æ€»å†…å­˜è¶³å¤Ÿï¼Œå´ç”³è¯·ä¸åˆ°è¿ç»­çš„å¤§å—å†…å­˜ã€‚

![ç‘å£«å¥¶é…ª](C:\Users\xlp\Desktop\å›¾ç‰‡å­˜æ”¾\ç‘å£«å¥¶é…ª.png)

è¿™å¼ å›¾ç‰‡åº”è¯¥æ˜¯æ¯”è¾ƒå½¢è±¡çš„ï¼Œå¤§å®¶çœ‹åˆ°è¿™å¼ å›¾ç‰‡åº”è¯¥èƒ½å¤Ÿæ˜ç™½å†…å­˜ç¢ç‰‡åŒ–å¤§æ¦‚æ˜¯ä»€ä¹ˆæ„æ€äº†ã€‚

### 3.1.2 å†…å­˜åˆ†é…çš„æ€§èƒ½å¼€é”€

`malloc` å’Œ `free` å¹¶ä¸æ˜¯ç®€å•çš„ C è¯­å¥ï¼Œå®ƒä»¬æ˜¯**ç³»ç»Ÿåº“å‡½æ•°**ã€‚å®ƒä»¬å†…éƒ¨ç»´æŠ¤ç€å¤æ‚çš„å†…å­˜é“¾è¡¨ï¼Œå¹¶ä¸”ä¸ºäº†**çº¿ç¨‹å®‰å…¨**ï¼Œmalloc å†…éƒ¨é€šå¸¸ä¹Ÿæœ‰**é”**ã€‚

å¹¶ä¸”åœ¨å†…å­˜ç¢ç‰‡åŒ–åï¼Œ`malloc`è°ƒç”¨äº§ç”Ÿçš„**å¼€é”€ä¼šè¶Šæ¥è¶Šå¤§**ï¼Œå› ä¸ºå†…å­˜ä¸Šçš„å­”æ´è¶Šæ¥è¶Šå¤šï¼Œè¿™ä½¿å¾—å¯»æ‰¾ä¸€å—åˆé€‚å¤§å°çš„å†…å­˜è¶Šæ¥è¶Šå›°éš¾ã€‚é«˜é¢‘è°ƒç”¨ `malloc` æœ¬èº«å°±ä¼šæ¶ˆè€—å¤§é‡çš„ CPU æ—¶é—´ï¼Œè¿™å·²ç»è¿èƒŒäº†æˆ‘ä»¬æé€Ÿå†™å…¥çš„åˆè¡·ã€‚

### 3.1.3 CPU ç¼“å­˜å¯¹é“¾è¡¨ä¸å‹å¥½

æœ‰æœ‹å‹å°±æƒ³é—®äº†ï¼šâ€œä¸ºä»€ä¹ˆCPUç¼“å­˜å¯¹é“¾è¡¨ä¸å‹å¥½å‘¢ï¼Ÿéš¾é“å®ƒå¯¹æ•°ç»„å°±å¾ˆå‹å¥½å—ï¼Ÿâ€ã€‚æ˜¯çš„ï¼Œä»–å¯¹æ•°ç»„ç¡®å®å‹å¥½ï¼Œä½†è¿™å¹¶ä¸æ˜¯å®ƒæ­§è§†é“¾è¡¨ï¼Œè€Œæ˜¯ç”±CPUæœ¬èº«çš„ç‰¹æ€§å†³å®šçš„ã€‚

ä¼—æ‰€å‘¨çŸ¥ï¼Œæ•°ç»„çš„å†…å­˜æ˜¯è¿ç»­çš„ï¼Œè€Œé“¾è¡¨çš„èŠ‚ç‚¹åœ¨å †å†…å­˜ä¸­åˆ†æ•£åˆ†å¸ƒç€ï¼Œéå†é“¾è¡¨éœ€è¦éšæœºè·³è·ƒè®¿é—®å†…å­˜ï¼Œå¯¼è‡´ **Cache Missï¼ˆç¼“å­˜æœªå‘½ä¸­ï¼‰** ç‡æé«˜ï¼Œä¸¥é‡æ‹–æ…¢ CPU æ•ˆç‡ã€‚

å¹¶ä¸”CPUè¯»å–å†…å­˜æ—¶ï¼Œä¼šåˆ©ç”¨ **ç©ºé—´å±€éƒ¨æ€§** å°†ç›¸é‚»çš„æ•°æ®é¢„å–åˆ° **L1/L2 Cache** ä¸­ï¼Œå› æ­¤æ•°ç»„å°±å æ®äº†å¤©ç„¶çš„ä¼˜åŠ¿ã€‚

è¿™é‡Œæœ‰å¿…è¦æ‹“å±•ä¸€ä¸‹ **Cache Miss** ï¼Œç”¨ä¸€å¥é€šä¿—ç‚¹çš„è¯æ¥è®²ï¼šç°ä»£ CPU æ€§èƒ½çš„æå¤§ç¨‹åº¦ä¸Šå–å†³äºæ•°æ®ç¦»æ ¸å¿ƒæœ‰å¤šè¿‘ï¼Œè€Œ **Cache Miss** æ­£æ˜¯ç”±äºè¦è®¿é—®çš„æ•°æ®å¤ªè¿œæ‰€å¯¼è‡´çš„ã€‚

ä¸‹é¢è¦èŠçš„æ˜¯è®¡ç®—æœºä½“ç³»ç»“æ„ä¸­æ¯”è¾ƒç»å…¸çš„å†…å®¹ï¼Œå¯èƒ½ä¼šæ¯”è¾ƒæ¯ç‡¥ï¼Œä½†æˆ‘ä¼šå°½åŠ›æŠŠå®ƒæè¿°çš„å½¢è±¡ä¸€ç‚¹ï¼š

#### 3.1.3.1 Cacheçš„å±‚çº§ç»“æ„

é€šå¸¸æˆ‘ä»¬è¯´L1ï¼ŒL2ï¼ŒL3ä¸‰å±‚ç¼“å­˜ã€‚

**L1 Cacheï¼ˆä¸€çº§ç¼“å­˜ï¼‰**ï¼šç¦» CPU æ ¸å¿ƒæœ€è¿‘ï¼Œå°±åœ¨æ ¸å¿ƒå†…éƒ¨ã€‚é€Ÿåº¦æœ€å¿«ï¼Œä½†å†…å­˜æœ€å°ï¼Œå¤§å°ä¸º32æˆ–64KBï¼Œé€Ÿåº¦çº¦**1çº³ç§’**ã€‚

**L2 Cacheï¼ˆäºŒçº§ç¼“å­˜ï¼‰**ï¼šç¨å¾®è¿œä¸€ç‚¹ï¼Œ**é€šå¸¸**ä¹Ÿæ˜¯æ¯ä¸ªæ ¸å¿ƒç‹¬äº«ã€‚æ¯” L1 æ…¢ä¸€ç‚¹ï¼Œä½†å†…å­˜æ›´å¤§ï¼Œ256KB æˆ– 512KBã€‚é€Ÿåº¦çº¦ **3-10 çº³ç§’**ã€‚

**L3 Cacheï¼ˆä¸‰çº§ç¼“å­˜ï¼‰**ï¼šæ‰€æœ‰ CPU æ ¸å¿ƒ**å…±äº«**çš„ã€‚æ›´å¤§ï¼Œä½†æ›´æ…¢ï¼Œå‡  MB åˆ°å‡ å MBï¼Œé€Ÿåº¦çº¦ **10-20 çº³ç§’**ã€‚

**å†…å­˜**ï¼šä¸»æ¿ä¸Šçš„å†…å­˜æ¡ã€‚å·¨å¤§ä½†ææ…¢ï¼Œé€Ÿåº¦çº¦ **60-100 çº³ç§’**ã€‚

![ä¸‰å±‚ç¼“å­˜](C:\Users\xlp\Desktop\å›¾ç‰‡å­˜æ”¾\ä¸‰å±‚ç¼“å­˜.png)

è¿™å¼ å›¾æ˜¯æˆ‘ç”µè„‘çš„é…ç½®ï¼Œå¯ä»¥çœ‹åˆ°å®ƒæ˜¯16æ ¸çš„ã€‚L1ç¼“å­˜ä¸º1MBï¼Œå¹³æ‘Šåˆ°æ¯ä¸ªæ ¸ä¸Šé¢å°±æ˜¯64KB/æ ¸ã€‚L2ç¼“å­˜å¹³æ‘Šåˆ°æ¯ä¸ªæ ¸ä¸Šé¢æ˜¯1MB/æ ¸ã€‚L3ç¼“å­˜çš„64MBæ˜¯æ‰€æœ‰16ä¸ªæ ¸å¿ƒå…±äº«çš„ã€‚

è¿™ä¸ªé…ç½®çœ‹èµ·æ¥æ¯”ä¸Šé¢ä»‹ç»çš„å‚æ•°è¦å¤§ä¸€ç‚¹ï¼ˆå®é™…ä¸Šå¤§å·®ä¸å·®ï¼‰ï¼Œä½†æ˜¯åšåµŒå…¥å¼å¼€å‘æ—¶ï¼Œé¢å¯¹çš„æ¿å­å¯èƒ½æ ¹æœ¬å°±æ²¡æœ‰L2å’ŒL3ç¼“å­˜ã€‚**Cache Miss** çš„ä»£ä»·ä¼šç›´æ¥ååº”åœ¨è®¾å¤‡å¡é¡¿ä¸Šã€‚

#### 3.1.3.2 ä»€ä¹ˆæ˜¯ Cache Miss

å…ˆä»‹ç»ä¸€ä¸‹ä»€ä¹ˆæ˜¯ **Cache Lineï¼ˆç¼“å­˜è¡Œï¼‰** ï¼Œå¦‚æœCPUè¦è®¿é—®ä¸€ä¸ªå­—èŠ‚ï¼Œç³»ç»Ÿä¸ä¼šåªç»™å®ƒè¿™ä¸€ä¸ªå­—èŠ‚ï¼Œè€Œæ˜¯æŠŠè¿™ä¸ªå­—èŠ‚æ‰€åœ¨çš„ **Cache Line** å…¨éƒ¨ç»™å®ƒï¼Œè¿™ä¸ª **Cache Line** é€šå¸¸æ˜¯**64å­—èŠ‚**ã€‚è¿™æ„å‘³ç€ï¼Œå½“è¯»å–å†…å­˜åœ°å€ 0x1000 æ—¶ï¼ŒCPU ä¼šè‡ªåŠ¨æŠŠ 0x1000 åˆ° 0x103F çš„ 64 å­—èŠ‚å…¨éƒ¨åŠ è½½åˆ° Cache ä¸­ã€‚

**æ¯ä¸€æ¬¡æŸ¥æ‰¾å¤±è´¥ï¼Œéƒ½å«ä¸€æ¬¡ Missã€‚**

å½“CPUè¦è¯»å–ä¸€ä¸ªå˜é‡æ—¶ï¼Œå®ƒä¼šå…ˆæŸ¥L1ï¼Œå¦‚æœL1å‘½ä¸­å°±ç›´æ¥ä½¿ç”¨ï¼Œè€—æ—¶1nsã€‚å¦‚æœL1æœªå‘½ä¸­å°±æŸ¥L2ã€‚

å¦‚æœL2å‘½ä¸­ï¼ŒæŠŠæ•°æ®æ¬åˆ°L1å†ç»™CPUï¼Œè€—æ—¶5nsã€‚å¦‚æœL2æœªå‘½ä¸­å°±æŸ¥L3ã€‚

å¦‚æœL3å‘½ä¸­ï¼ŒæŠŠæ•°æ®æ¬åˆ°L2ï¼Œå†æ¬åˆ°L1å†ç»™CPUï¼Œè€—æ—¶15nsã€‚å¦‚æœL3ä¹ŸæŸ¥ä¸åˆ°ï¼Œé‚£å°±æ‚²å‰§äº†ã€‚

æ­¤æ—¶ï¼ŒCPUåªèƒ½æŒ‚èµ·ç­‰å¾…ï¼Œè®©å†…å­˜æ§åˆ¶å™¨å»RAMé‡Œé¢æ‰¾è¿™ä¸€ç­‰å¯èƒ½å°±æ˜¯ä¸Šç™¾çº³ç§’ã€‚å¯¹äº 2GHz çš„ CPU æ¥è¯´ï¼Œ100ns æ„å‘³ç€å®ƒå¯ä»¥ç©ºè½¬ **200 ä¸ªå‘¨æœŸ**ã€‚è¿™æ®µæ—¶é—´ CPU ä»€ä¹ˆéƒ½å¹²ä¸äº†ï¼Œçº¯æµªè´¹ã€‚

å¯¹äºæ•°ç»„ï¼šæ•°ç»„åœ¨å†…å­˜é‡Œæ˜¯**è¿ç»­å­˜æ”¾**çš„ã€‚å½“CPUè¦è®¿é—®**æ•°ç»„ç¬¬ä¸€ä¸ªå…ƒç´ **ï¼Œå¤§æ¦‚ç‡æ˜¯ä¸åœ¨ä¸‰å±‚ç¼“å­˜çš„ï¼Œä»–å¯èƒ½è¦ç­‰å¾ˆä¹…æ•°æ®æ‰èƒ½è¢«æ‹¿è¿‡æ¥ï¼Œé€Ÿåº¦å½“ç„¶å°±æ¯”è¾ƒæ…¢äº†ï¼Œè¿™å« **Cache Miss** ã€‚ä½†å®ƒæ‹¿å›æ¥çš„æ˜¯æ•°ç»„ç¬¬ä¸€ä¸ªå…ƒç´ æ‰€åœ¨çš„ **Cache Line** ï¼Œå…±64ä¸ªå­—èŠ‚ã€‚å½“ä»–å¤„ç†å®Œç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œè¦å¤„ç†ç¬¬äºŒä¸ªæ—¶ï¼Œå“ï¼Œå®ƒå‘ç°ç¬¬äºŒä¸ªå…ƒç´ å°±åœ¨ä»–æ‰‹è¾¹ï¼Œå®ƒå¯ä»¥å¾ˆå¿«çš„å¤„ç†å®Œç¬¬äºŒä¸ªå…ƒç´ ï¼Œè¿™å« **Cache Hitï¼ˆç¼“å­˜å‘½ä¸­ï¼‰** ã€‚å¹¶ä¸”åé¢å®ƒè¦å¤„ç†çš„å…ƒç´ å¯èƒ½å…¨éƒ½åœ¨å®ƒæ‰‹è¾¹ï¼Œä¹Ÿå°±æ˜¯è¯´åé¢å¯èƒ½å…¨éƒ¨ **Cache Hit** ï¼Œè¿™æ ·æ•ˆç‡æ˜¯æé«˜çš„ã€‚

å¯¹äºé“¾è¡¨ï¼šé“¾è¡¨çš„ç»“ç‚¹æ˜¯`malloc`å‡ºæ¥çš„ï¼Œåœ¨å †å†…å­˜é‡Œé¢çš„åˆ†å¸ƒæ˜¯æ²¡æœ‰è§„çŸ©å¯è¨€çš„ã€‚è¿™æ—¶CPUè¦è®¿é—®æ¯ä¸€ä¸ªç»“ç‚¹ï¼Œè€Œè¿™äº›ç»“ç‚¹å­˜åœ¨äºä¸‰å±‚ç¼“å­˜çš„æ¦‚ç‡å¾ˆå°ï¼Œå¹¶ä¸”é“¾è¡¨æ²¡æœ‰åƒæ•°ç»„é‚£æ ·ï¼Œä¸€æ¬¡è®¿é—®æ…¢ä½†å¯¹åé¢å¤šæ¬¡è®¿é—®æ•ˆç‡æå‡å…·æœ‰ä¿ƒè¿›ä½œç”¨çš„æœºåˆ¶ã€‚å› æ­¤ï¼Œå¦‚æœä½¿ç”¨é“¾è¡¨ï¼Œ**Cache Miss** çš„æ¦‚ç‡æé«˜ã€‚

#### 3.1.3.3 ä¸€ç‚¹å°è¡¥å……

åœ¨é«˜ç«¯åµŒå…¥å¼ SoCï¼ˆå¦‚æ ‘è“æ´¾ã€æ‰‹æœº Cortex-Aï¼‰ä¸­ï¼Œé€šå¸¸æœ‰ L1/L2/L3 ä¸‰çº§ç¼“å­˜ã€‚ä½†åœ¨ä½ç«¯å•ç‰‡æœºï¼ˆå¦‚ STM32 Cortex-M3/M4ï¼‰ä¸­ï¼Œé€šå¸¸**æ²¡æœ‰ Cache** æˆ–è€…åªæœ‰ç®€å•çš„ **æŒ‡ä»¤/æ•°æ®ç¼“å­˜**ã€‚
å°½ç®¡å¦‚æ­¤ï¼Œ**RAM çš„çªå‘è¯»å–ï¼ˆBurst Readï¼‰**ç‰¹æ€§ä¾ç„¶ä½¿å¾—é¡ºåºè®¿é—®ï¼ˆæ•°ç»„ï¼‰æ¯”éšæœºè®¿é—®ï¼ˆé“¾è¡¨ï¼‰å¿«å¾—å¤šã€‚

ç°ä»£ RAM çš„ Burst Read ç‰¹æ€§è®©é¡ºåºè¯»å†™ 64 å­—èŠ‚å’Œéšæœºè¯» 1 å­—èŠ‚çš„ç¡¬ä»¶æˆæœ¬å‡ ä¹ä¸€æ ·ã€‚ é…åˆ CPU ç¡¬ä»¶é¢„å–å™¨å’Œå¤šçº§ç¼“å­˜ï¼ŒçœŸæ­£è¿ç»­ã€64 å­—èŠ‚å¯¹é½çš„é¡ºåºè®¿é—®ï¼ˆRing Bufferï¼‰å¯ä»¥æ¯”éšæœºè·³è·ƒçš„é“¾è¡¨å¿« 10ï½50 å€ï¼Œè€Œä¸”è¿™ä¸æ˜¯è½¯ä»¶ä¼˜åŒ–ï¼Œæ˜¯ç‰©ç†åº•å±‚çš„ç¡¬åŠ é€Ÿï¼Œæ²¡å¾—é€‰ã€‚

æ‰€ä»¥ï¼š **Ring Buffer å¿«ä¸æ˜¯å› ä¸ºä»£ç å†™å¾—å¥½ï¼Œè€Œæ˜¯å› ä¸ºå®ƒåƒåˆ°äº† CPU + Cache + DRAM ä¸‰è€…è”åˆçš„çº¢åˆ©**ã€‚ é“¾è¡¨å†ä¼˜é›…ï¼Œä¹Ÿæ‰“ä¸è¿‡ç‰©ç†å®šå¾‹ã€‚

## 3.2 ç¯å½¢ç¼“å†²åŒºè®¾è®¡åŸç†

ç¯å½¢ç¼“å†²åŒºæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª**å›ºå®šå¤§å°çš„æ•°ç»„**ï¼Œé€šè¿‡ç»´æŠ¤ `head`ï¼ˆè¯»æŒ‡é’ˆï¼‰å’Œ `tail`ï¼ˆå†™æŒ‡é’ˆï¼‰ä¸¤ä¸ªç´¢å¼•ï¼Œå’Œ**å–æ¨¡è¿ç®—**æ¥å®ç°é¦–å°¾ç›¸æ¥çš„å¾ªç¯çš„æ•ˆæœã€‚

ä¸‹é¢ä»‹ç»ä¸€ä¸‹å®ç°çš„æ ¸å¿ƒé€»è¾‘ï¼š

1. åˆå§‹åŒ–ï¼šç”³è¯·ä¸€å—å¤§å†…å­˜ï¼ˆä¾‹å¦‚ 1MBï¼‰ï¼Œè¿™æ˜¾ç„¶ä¸ä¼šé€ æˆå†…å­˜ç¢ç‰‡åŒ–ã€‚ç»™ `head` å’Œ `tail` èµ‹0 ã€‚

2. å†™å…¥ (Push)ï¼šæ•°æ®å­˜å…¥ `buffer[tail]`ï¼Œç„¶å `tail` å‘åç§»åŠ¨ã€‚

   ç„¶å `tail = (tail + 1) % capacity`

3. è¯»å– (Pop)ï¼šä» `buffer[head]` å–å‡ºæ•°æ®ï¼Œç„¶å `head` å‘åç§»åŠ¨ã€‚

   ç„¶å `head = (head + 1) % capacity`

4. åˆ¤æ–­æ˜¯å¦ç©ºæˆ–è€…æ»¡ï¼šé€šè¿‡ä¸€ä¸ª `count` è®¡æ•°å™¨ï¼Œæˆ–è€…é€šè¿‡ `head` å’Œ `tail` çš„ç›¸å¯¹ä½ç½®æ¥åˆ¤æ–­ã€‚

åœ¨æœ¬é¡¹ç›®ä¸­ï¼Œä¸ºäº†ç®€åŒ–å¤šçº¿ç¨‹ä¸‹çš„çŠ¶æ€åˆ¤æ–­ï¼Œæˆ‘å¼•å…¥äº†ä¸€ä¸ª`count`è®¡æ•°å™¨é…åˆäº’æ–¥é”æ¥ç²¾ç¡®æ§åˆ¶ã€‚

å°çŸ¥è¯†ï¼šåœ¨æåº¦è¿½æ±‚æ€§èƒ½çš„åœºæ™¯ä¸‹ï¼ˆå¦‚ Linux å†…æ ¸ kfifoï¼‰ï¼Œé€šå¸¸ä¼šå°†ç¼“å†²åŒºå¤§å°è®¾ç½®ä¸º **2 çš„å¹‚æ¬¡æ–¹**ï¼ˆå¦‚ 1024, 4096ï¼‰ã€‚è¿™æ ·å¯ä»¥ç”¨ **ä½è¿ç®— (&)** ä»£æ›¿ **å–æ¨¡è¿ç®— (%)**ï¼š

å–æ¨¡ï¼š`tail = (tail + 1) % 1024`

å¯¹åº”çš„ä½è¿ç®—ï¼š`tail = (tail + 1) & (1024 - 1)`

## 3.3 æ ¸å¿ƒæ•°æ®ç»“æ„å®šä¹‰

ä¸ºäº†å®ç°é€šç”¨æ€§ä¸å°è£…æ€§ï¼Œæˆ‘å®šä¹‰äº†ä¸‹é¢ç»“æ„ä½“ï¼š

```C
// å•æ¡æ—¥å¿—çš„æœ€å¤§é•¿åº¦
#define LOG_MSG_SIZE 128

// æ—¥å¿—
typedef struct {
    char data[LOG_MSG_SIZE];
} Log;

// ç¯å½¢ç¼“å†²åŒºç®¡ç†
typedef struct {
    Log *entries;         // æŒ‡å‘ malloc çš„å¤§æ•°ç»„
    
    int capacity;         // ç¼“å†²åŒºæ€»å®¹é‡
    int count;            // å½“å‰å·²å­˜å‚¨çš„æ—¥å¿—æ•°é‡
    
    int head;             // è¯»ç´¢å¼• (Consumer ç”¨)
    int tail;             // å†™ç´¢å¼• (Producer ç”¨)
    
    // ç”¨äºä¼˜é›…é€€å‡º
    int is_running;       // 1: æ­£å¸¸è¿è¡Œ   0: åœæ­¢

    // çº¿ç¨‹åŒæ­¥å·¥å…·
    pthread_mutex_t mutex;
    pthread_cond_t cond_producer; // è‹¥ç¼“å†²åŒºæ»¡  ç”Ÿäº§è€…ç¡è§‰
    pthread_cond_t cond_consumer; // è‹¥ç¼“å†²åŒºç©º  æ¶ˆè´¹è€…ç¡è§‰
    
    //å­˜æ”¾æ—¥å¿—å†…å®¹çš„æ–‡ä»¶çš„æ–‡ä»¶æè¿°ç¬¦
    int file_fd;
} RingBuffer;
```

è¿™ç§è®¾è®¡å³ä¿è¯äº†**å†…å­˜çš„è¿ç»­æ€§**ï¼Œåˆé€šè¿‡äº’æ–¥é”å’Œæ¡ä»¶å˜é‡ä¿è¯äº†**çº¿ç¨‹å®‰å…¨**ã€‚åœ¨ç¨‹åºå¯åŠ¨æ—¶ `rb_init` ä¸€æ¬¡æ€§åˆ†é…å†…å­˜ï¼Œè¿è¡Œè¿‡ç¨‹ä¸­å†æ— å†…å­˜ç”³è¯·æ“ä½œï¼Œæå…¶ç¨³å®šã€‚

è¿™é‡Œçš„æ–‡ä»¶æè¿°ç¬¦éœ€è¦å†æä¸€å˜´ï¼Œåˆå§‹åŒ–çš„æ—¶å€™æˆ‘ä¼šæŠŠå®ƒç½®ä¸º1ï¼Œä»£è¡¨`stdout`ï¼Œä¹Ÿå°±æ˜¯è¯´é»˜è®¤çš„æ—¥å¿—è¾“å‡ºä½ç½®æ˜¯ç»ˆç«¯ã€‚åé¢å¦‚æœè¦æ‰“å¼€æ–‡ä»¶æ—¶é‚£å°±ç»™ä»–å†æ¬¡èµ‹å€¼ã€‚å¦‚æœåªæ˜¯ç”¨æ¥æµ‹è¯•ï¼ŒæŸ¥çœ‹ç»ˆç«¯å†…å®¹ï¼Œå› è€Œä¸è¿›è¡Œå¯¹æ–‡ä»¶æè¿°ç¬¦é‡æ–°èµ‹å€¼çš„æ“ä½œï¼Œé‚£å°±è¦åœ¨`close`ä¹‹å‰è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœæ–‡ä»¶æè¿°ç¬¦çš„å€¼ä¸º1ï¼Œå°±ä¸è¿›è¡Œ`close`æ“ä½œã€‚ä½†æ˜¯ä¸ºäº†ä¿é™©èµ·è§ï¼Œæˆ‘å»ºè®®ä¸è®ºä¼šä¸ä¼šå¯¹æ–‡ä»¶æè¿°ç¬¦é‡æ–°èµ‹å€¼ï¼Œåœ¨å…³é—­æ–‡ä»¶æè¿°ç¬¦ä¹‹å‰éƒ½æ£€æŸ¥ä¸€ä¸‹å®ƒçš„å€¼ã€‚



# 4. æ ¸å¿ƒä»£ç å®ç°

ä¸ºäº†ä¿è¯ä»£ç çš„**å¥å£®æ€§**ä¸**å¯ç»´æŠ¤æ€§**ï¼Œæˆ‘å°†æ ¸å¿ƒé€»è¾‘å°è£…åœ¨ ring_buffer.c ä¸­ï¼Œå¯¹å¤–æä¾›ç®€æ´çš„ APIã€‚ä»¥ä¸‹æ˜¯å‡ ä¸ªæœ€å…³é”®çš„å®ç°ç»†èŠ‚ã€‚

## 4.1 åˆå§‹åŒ– â€”â€” ä¸€åˆ‡çš„èµ·ç‚¹

åœ¨åˆå§‹åŒ–é˜¶æ®µï¼Œæˆ‘ä»¬éœ€è¦ç”³è¯·å†…å­˜æ± ï¼Œå¹¶åˆå§‹åŒ–æ‰€æœ‰çš„åŒæ­¥å·¥å…·ï¼ˆé”ä¸æ¡ä»¶å˜é‡ï¼‰ã€‚è¿™é‡Œæœ‰ä¸€ä¸ªè®¾è®¡ç»†èŠ‚ï¼Œä¹Ÿå°±æ˜¯ä¸Šæ–‡æåˆ°çš„ï¼šæˆ‘ä»¬å°† `file_fd` é»˜è®¤åˆå§‹åŒ–ä¸º `STDOUT_FILENO` (1)ï¼Œè¿™æ„å‘³ç€é»˜è®¤æƒ…å†µä¸‹æ—¥å¿—ä¼šè¾“å‡ºåˆ°ç»ˆç«¯ï¼Œæ–¹ä¾¿è°ƒè¯•ã€‚

```C
void rb_init(RingBuffer *rb, int capacity) {
    //ä¸€æ¬¡æ€§ç”³è¯·å †å†…å­˜
    rb->entries = (Log *)malloc(sizeof(Log) * capacity);
    if (rb->entries == NULL) {
        perror("malloc failed");
        exit(1);
    }

    //åˆå§‹åŒ–çŠ¶æ€
    rb->capacity = capacity;
    rb->head = 0;
    rb->tail = 0;
    rb->count = 0;
    rb->is_running = 1; //æ ‡è®°ç³»ç»Ÿè¿è¡Œä¸­

    //é»˜è®¤è¾“å‡ºåˆ°ç»ˆç«¯
    rb->file_fd = STDOUT_FILENO;

    //åˆå§‹åŒ–äº’æ–¥é”å’Œæ¡ä»¶å˜é‡
    pthread_mutex_init(&(rb->mutex), NULL);
    pthread_cond_init(&(rb->cond_producer), NULL);
    pthread_cond_init(&(rb->cond_consumer), NULL);
}
```

è¿™ä¸ªåˆå§‹åŒ–å‡½æ•°çš„å†…å­˜åˆ†é…æ­£æ˜¯ç»“åˆäº†æˆ‘ä»¬å‰é¢ä¸€æ¬¡æ€§ç”³è¯·ä¸€å¤§å—è¿ç»­å†…å­˜çš„æ€è·¯ï¼Œåœ¨åŠ å¿«è®¿é—®é€Ÿåº¦çš„åŸºç¡€ä¸Šè¿˜ä¸€å®šç¨‹åº¦ä¸Šä¿æŠ¤äº†Flashã€‚

é»˜è®¤æƒ…å†µä¸‹`is_running`æ˜¯ä¸º1çš„ï¼Œä»è¿™ä¸ªæˆå‘˜çš„åå­—å¾ˆå®¹æ˜“å°±èƒ½çœ‹å‡ºå®ƒä¸º1æ˜¯æ˜¯æ­£å¸¸å·¥ä½œçš„ã€‚åé¢åœ¨`main`å‡½æ•°æˆåŠŸå›æ”¶å…¨éƒ¨ç”Ÿäº§è€…æ—¶å°†è¿™ä¸ªå€¼ç½®ä¸º0ï¼Œåœ¨æ¶ˆè´¹è€…ä¸­æ£€æµ‹è¿™ä¸ªå€¼ä¸º0åæ‰§è¡Œç›¸åº”çš„é€€å‡ºç¨‹åºï¼Œ**é˜²æ­¢ç”Ÿäº§è€…å·²ç»å…¨éƒ¨é€€å‡ºäº†æ¶ˆè´¹è€…è¿˜åœ¨è‹¦è‹¦ç­‰å¾…**æ—¥å¿—ä½œæ— ç”¨åŠŸè¿™ç§æƒ…å†µå‘ç”Ÿã€‚

æ—¥å¿—å†…å®¹çš„é»˜è®¤è¾“å‡ºä½ç½®å°±æ²¡å¿…è¦å†è®²äº†ï¼Œè¿™é‡Œåªæ˜¯ç”¨å®ä»£æ›¿äº†1ï¼Œç›´æ¥ç”¨1ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œé™¤äº†**å¯è¯»æ€§ä¸‹é™**æ²¡æœ‰ä»€ä¹ˆåå¤„ã€‚

æœ€åå°±æ˜¯åˆå§‹åŒ–é”å’Œæ¡ä»¶å˜é‡äº†ï¼Œè¿™é‡Œæˆ‘è®¾è®¡äº†ä¸¤ä¸ªæ¡ä»¶å˜é‡ï¼Œä»åå­—æ¥çœ‹ä¸€ä¸ªæ˜¯å±äºç”Ÿäº§è€…çš„ï¼Œå¦ä¸€ä¸ªæ˜¯å±äºæ¶ˆè´¹è€…çš„ã€‚è‹¥ç¼“å†²åŒºä¸ºç©ºï¼Œåˆ™æ¶ˆè´¹è€…ç¡è§‰ï¼Œç›´åˆ°ç”Ÿäº§è€…ç”Ÿäº§å‡ºæ—¥å¿—å†…å®¹ï¼Œä¼šç”¨ `cond_consumer` æ¥å«é†’æ¶ˆè´¹è€…ã€‚è‹¥ç¼“å†²åŒºå·²æ»¡ï¼Œåˆ™ç”Ÿäº§è€…ç¡è§‰ï¼Œå½“æ¶ˆè´¹è€…æ¶ˆè´¹æ—¥å¿—å†…å®¹ä½¿å¾—ç¼“å†²åŒºç©ºé—´ç©ºå‡ºæ¥æ—¶ï¼Œä»–ä¼šä½¿ç”¨ `cond_producer` å«é†’ç”Ÿäº§è€…ã€‚è¿™åœ¨åé¢çš„å…·ä½“ä»£ç å®ç°ä¸­ä¼šç›´è§‚çš„çœ‹åˆ°ã€‚

## 4.2 ç”Ÿäº§è€… (`Push`)æ‹’ç»è™šå‡å”¤é†’

è¿™æ˜¯**é«˜å¹¶å‘å†™**çš„æ ¸å¿ƒé€»è¾‘ã€‚ä¸ºäº†é˜²æ­¢â€œæƒŠç¾¤æ•ˆåº”â€å’Œâ€œè™šå‡å”¤é†’â€ï¼Œå¿…é¡»ä¸¥æ ¼éµå®ˆ POSIX å¤šçº¿ç¨‹ç¼–ç¨‹è§„èŒƒã€‚

```C
void rb_push(RingBuffer *rb, const Log *entry) {
    pthread_mutex_lock(&(rb->mutex));

    while (rb->count == rb->capacity) {
        pthread_cond_wait(&(rb->cond_producer), &(rb->mutex));
    }

    // ç›´æ¥ memcpy åˆ°æ•°ç»„å¯¹åº”ä½ç½®
    memcpy(&(rb->entries[rb->tail]), entry, sizeof(Log));

    // æ›´æ–°ç´¢å¼•
    rb->tail = (rb->tail + 1) % rb->capacity;
    rb->count++;
    
    // å”¤é†’æ¶ˆè´¹è€…
    pthread_cond_signal(&(rb->cond_consumer));
    pthread_mutex_unlock(&(rb->mutex));
}
```

`Push`è¿™ä¸ªå•è¯å¾ˆå½¢è±¡ï¼Œæˆ‘ç›¸ä¿¡ä¸è§£é‡Šå¤§å®¶ä¹Ÿèƒ½çŸ¥é“è¿™é‡Œåœ¨å¹²ä»€ä¹ˆï¼Œè¿™ä¸ªå‡½æ•°å°±æ˜¯ç”¨æ¥æŠŠæ—¥å¿—å†…å®¹`Push`è¿›`RingBuffer`çš„ã€‚

è¿™é‡Œçš„åˆ¤æ–­ä¸ºä»€ä¹ˆè¦ä½¿ç”¨`while`å‘¢ï¼Œå¯èƒ½ä¼šæœ‰äº›å–œæ¬¢æ€è€ƒçš„æœ‹å‹è®¤çœŸçœ‹äº†ä¹‹åå‘ç°ï¼Œè¿™é‡Œåªæ˜¯åˆ¤æ–­ä¸€ä¸‹ç¼“å†²åŒºå†…çš„æ—¥å¿—æ•°é‡æ˜¯å¦ç­‰äºç¼“å†²åŒºæœ€å¤§å®¹é‡ï¼Œä¹Ÿå°±æ˜¯åˆ¤æ–­ç¼“å†²åŒºæ»¡äº†æ²¡æœ‰ã€‚å¦‚æœæ»¡äº†é‚£å°±ç­‰å‘—ï¼Œæ²¡æ»¡é‚£å°±ç»§ç»­ç”Ÿäº§æ—¥å¿—å‘—ã€‚é‚£æŒ‰é“ç†æ¥è¯´ç”¨`if`æ¥åˆ¤æ–­ä¹Ÿè¡Œå•Šï¼Ÿå…¶å®æ˜¯ä¸è¡Œçš„ï¼Œè¿™é‡Œå­˜åœ¨ä¸€ä¸ª**è™šå‡å”¤é†’**çš„æƒ…å†µã€‚

**è™šå‡å”¤é†’**æ˜¯æŒ‡ï¼Œçº¿ç¨‹åœ¨è°ƒç”¨ `pthread_cond_wait()` å¼€å§‹ç¡è§‰ä¹‹åï¼Œå³ä½¿æ²¡æœ‰ä»»ä½•äººè°ƒç”¨ `pthread_cond_signal()` æˆ–è€… `pthread_cond_broadcast()` ï¼Œçº¿ç¨‹ä¹Ÿæœ‰å¯èƒ½è«åå…¶å¦™çš„é†’æ¥ã€‚ä½†è¿™ä¸ªçœ‹ä¼¼å­˜åœ¨æ¼æ´çš„è¡Œä¸ºå…¶å®æ˜¯ POSIX æ ‡å‡†æ˜ç¡®å…è®¸çš„è¡Œä¸ºã€‚å¯¼è‡´è™šå‡å”¤é†’æ¯”è¾ƒå¸¸è§çš„åŸå› æœ‰ï¼šæ“ä½œç³»ç»Ÿè°ƒåº¦å™¨çš„å†…éƒ¨ä¼˜åŒ–ï¼Œå†…å­˜ä¼ªå…±äº«ï¼Œä¿¡å·ä¸­æ–­ç­‰ã€‚æ‰€ä»¥è¯´é†’æ¥å¹¶ä¸ä¸€å®šæ˜¯è¢« `signal` æˆ–è€… `broadcast` å”¤é†’çš„ï¼Œæ„æ€å°±æ˜¯æ¡ä»¶ä¸ä¸€å®šèƒ½æ»¡è¶³ã€‚

å¤§å®¶ç°åœ¨æ¥æƒ³è±¡ä¸€ä¸‹è¿™ä¸ªåœºæ™¯ï¼Œå‡å¦‚çº¿ç¨‹**ç”±äºè™šå‡å”¤é†’é†’æ¥**äº†ï¼Œä½†å®é™…ä¸Šè¿™æ—¶ç¼“å†²åŒºè¿˜æ˜¯æ»¡çš„ï¼Œå®ƒåº”è¯¥ç¡è§‰ï¼Œä¸åº”è¯¥é†’ç€ã€‚å¦‚æœä½¿ç”¨äº† `if` æ¥åˆ¤æ–­ï¼Œå®ƒä¼šä»€ä¹ˆéƒ½ä¸ç®¡ï¼Œç›´æ¥ç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œå…ˆæŠŠ `entry` çš„å†…å®¹æ‹·è´åˆ° `RingBuffer` ï¼Œç„¶åæ›´æ–°ç´¢å¼•å’Œæ—¥å¿—æ¡æ•°ï¼Œç„¶åå°±å®Œè›‹äº†(â•¯Â°â–¡Â°)â•¯ï¸µ â”»â”â”»ã€‚å› ä¸º**ç¼“å†²åŒºå·²ç»æº¢å‡º**äº†ã€‚

ä½†æ˜¯å¦‚æœè¿™é‡Œä½¿ç”¨`while`è¿›è¡Œåˆ¤æ–­ï¼Œåœ¨è§¦å‘è™šå‡å”¤é†’åï¼Œä»–ä¼š**é‡æ–°æ£€æŸ¥ç¼“å†²åŒºæ˜¯å¦æ»¡äº†**ï¼Œå¦‚æœæ²¡æ»¡å°±è·³å‡º `while` ï¼Œç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚å¦‚æœæ»¡äº†é‚£å°±åœ¨æ‰§è¡Œ `pthread_cond_wait(&(rb->cond_producer), &(rb->mutex));` è¿›å…¥ç¡çœ ã€‚ä¸ä¼šå‘ç”Ÿåƒ`if`é‚£æ ·çš„å¯æ€•åœºæ™¯ã€‚

## 4.3 æ¶ˆè´¹è€… (`Pop`) ä¸ä¼˜é›…é€€å‡º

æ¶ˆè´¹è€…ä¸ä»…è¦å¤„ç†æ•°æ®ï¼Œè¿˜è¦è´Ÿè´£ç›‘å¬**åœæœºæŒ‡ä»¤**ã€‚å¦‚æœåªæ˜¯ä¸€ä¸ª demo ï¼Œé‚£è®©æ¶ˆè´¹è€…ç›´æ¥æ— é™å¾ªç¯å°±å®Œäº‹äº†ï¼Œåé¢ç›´æ¥ Ctrl+C æš´åŠ›ç»ˆæ­¢ã€‚ä½†æ˜¯å¦‚æœæƒ³çœŸæ­£åº”ç”¨åˆ°å·¥ç¨‹ä¸Šï¼Œé‚£å°±è¦å®ç°**ä¼˜é›…é€€å‡º**ã€‚

```c
// å‡½æ•°è¿”å›å€¼ï¼š1 è¡¨ç¤ºæˆåŠŸæ‹¿åˆ°æ•°æ®ï¼Œ0 è¡¨ç¤ºç³»ç»Ÿå…³é—­ä¸”æ— æ•°æ®
int rb_pop(RingBuffer *rb, Log *entry) {
    pthread_mutex_lock(&(rb->mutex));

    // åªæœ‰å½“ç¼“å†²åŒºä¸ºç©ºï¼Œä¸”ç³»ç»Ÿè¿˜åœ¨è¿è¡Œæ—¶ï¼Œæ‰é€‰æ‹©ç­‰å¾…
    while (rb->count == 0 && rb->is_running) {
        pthread_cond_wait(&(rb->cond_consumer), &(rb->mutex));
    }

    // å¦‚æœé†’æ¥å‘ç°æ²¡æ•°æ®äº†ï¼Œè€Œä¸”ç³»ç»Ÿæ ‡å¿—ä½å·²å…³é—­ï¼Œé‚£å°±è§£é”åé€€å‡º
    if (rb->count == 0 && !rb->is_running) {
        pthread_mutex_unlock(&(rb->mutex));
        return 0; 
    }

    // æ­£å¸¸æ¶ˆè´¹
    memcpy(entry, &(rb->entries[rb->head]), sizeof(Log));
    rb->head = (rb->head + 1) % rb->capacity;
    rb->count--;

    // å”¤é†’ç”Ÿäº§è€…
    pthread_cond_signal(&(rb->cond_producer));
    pthread_mutex_unlock(&(rb->mutex));
    return 1;
}
```

ä»£ç ä¸­å·²ç»æœ‰äº†æ¯”è¾ƒè¯¦ç»†çš„æ³¨é‡Šï¼Œä½†ä¸ºäº†å†…å®¹çš„å…¨é¢æ€§ï¼Œæˆ‘è¿˜æ˜¯ç®€å•ä»‹ç»ä¸€ä¸‹è¿™ä¸ªå‡½æ•°ã€‚

å…ˆæ¥çœ‹ `while` å¾ªç¯ï¼Œåªæœ‰å½“ç¼“å†²åŒºä¸ºç©ºï¼Œè€Œä¸”ç³»ç»Ÿè¿˜åœ¨è¿è¡Œæ—¶ï¼Œæ‰ç­‰å¾…ã€‚

å¦‚æœç¼“å†²åŒºä¸ºç©ºï¼Œä½† `is_running` è¢«ç½®ä¸º0äº†ï¼Œé‚£å°±è·³å‡ºå¾ªç¯ï¼Œå¾€ä¸‹æ‰§è¡Œåˆ° `if` ï¼Œæ¡ä»¶æ»¡è¶³ï¼Œè§£é”åç›´æ¥è¿”å›0ï¼Œåé¢åœ¨æ¶ˆè´¹è€…çº¿ç¨‹ä¸­ä¼šæ£€æŸ¥è¿™ä¸ªè¿”å›å€¼ï¼Œè¿™ä¸ªåˆ°åé¢å†è¯´å§ã€‚

å¦‚æœç¼“å†²åŒºä¸ä¸ºç©ºï¼Œä¸” `is_running` ä¸º1ï¼Œæ­£å¸¸è¿è¡Œï¼Œé‚£å°±æ˜¯æ­£å¸¸æ¶ˆè´¹åå”¤é†’ç”Ÿäº§è€…ï¼Œå‡½æ•°è¿”å›1ã€‚

å¦‚æœç¼“å†²åŒºä¸ä¸ºç©ºï¼Œä¸” `is_running` ä¸º0ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œç”Ÿäº§è€…å·²ç»å…¨éƒ¨é€€å‡ºäº†ï¼Œä½†ç¼“å†²åŒºè¿˜æœ‰äº›æ—¥å¿—å†…å®¹æ²¡æœ‰è¢«æ¶ˆè´¹ã€‚é‚£æˆ‘ä»¬çš„é€»è¾‘å°±æ˜¯**æ¶ˆè´¹å®Œè¿™äº›æ—¥å¿—å†é€€å‡º**ã€‚æ¥çœ‹ä»£ç ï¼Œè¿™ç§æƒ…å†µä¾ç„¶ä¼šè·³å‡º `while` å¾ªç¯ï¼Œåœ¨ `if`  åˆ¤æ–­æ˜¯ï¼Œæ˜¯ä¸æ»¡è¶³æ¡ä»¶çš„ï¼Œæ‰€ä»¥ä¸ä¼šåœ¨ `if` é‡Œé¢é€€å‡ºï¼Œè€Œæ˜¯ç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œæ­£å¸¸æ¶ˆè´¹æ—¥å¿—ï¼Œå®Œäº†è¿”å›1ï¼Œåˆ°åé¢å¤§å®¶ä¼šçŸ¥é“ï¼Œ**æ¶ˆè´¹è€…çº¿ç¨‹æ˜¯åœ¨å¾ªç¯è°ƒç”¨**è¿™ä¸ªå‡½æ•°çš„ï¼Œæ‰€ä»¥ä¼šä¸€ç›´é‡å¤ä¸Šé¢æè¿°çš„è¿‡ç¨‹ï¼Œç›´åˆ°æ—¥å¿—å…¨éƒ¨è¢«æ¶ˆè´¹å®Œï¼Œç¼“å†²åŒºç©ºäº†ï¼Œè¿™æ—¶æ»¡è¶³ `if` çš„æ¡ä»¶äº†ï¼Œè¿”å›0ã€‚æ¶ˆè´¹è€…çº¿ç¨‹æ£€æµ‹åˆ°0åä¼˜é›…é€€å‡ºã€‚

è¿™é‡Œæˆ‘è¿˜æƒ³æä¸€ç‚¹ï¼Œæˆ‘åœ¨ 4.2 å’Œ æœ¬èŠ‚4.3 é‡Œéƒ½ç”¨äº† `memcpy`ã€‚åœ¨è¿™é‡Œä½¿ç”¨ `memcpy` æ˜¯å®‰å…¨çš„ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨ `log_push` é‡Œå·²ç»ç”¨ `snprintf` ä¿è¯äº†æºæ•°æ®é•¿åº¦ä¸ä¼šè¶…è¿‡ `LOG_MSG_SIZE`ï¼Œæ‰€ä»¥ä¸ä¼šå‘ç”Ÿè¶Šç•Œæ‹·è´ã€‚

ä¼˜é›…é€€å‡ºçš„ä»£ç æ²¡ä»€ä¹ˆæ·±åº¦ï¼Œæˆ‘å°±ä¸è§£é‡Šäº†ï¼Œç›´æ¥æ”¾åœ¨ä¸‹é¢ï¼š

```C
//ä¼˜é›…é€€å‡º
void rb_stop(RingBuffer *rb)
{
	pthread_mutex_lock(&(rb->mutex));

	rb->is_running = false;

	pthread_cond_broadcast(&(rb->cond_consumer));//å”¤é†’æ¶ˆè´¹è€…

	pthread_mutex_unlock(&(rb->mutex));
}
```



## 4.4 å®‰å…¨æ€§å°è£…æ‹’ç»ç¼“å†²åŒºæº¢å‡º

åœ¨ C è¯­è¨€ä¸­ï¼Œ`strncpy` å’Œ `sprintf` éƒ½æ˜¯ç¼“å†²åŒºæº¢å‡ºçš„é‡ç¾åŒºã€‚ä¸ºäº†ä¿è¯æ—¥å¿—å†…å®¹çš„å®‰å…¨ï¼Œæˆ‘åœ¨ä¸šåŠ¡å°è£…å±‚ä½¿ç”¨äº† `snprintf`ã€‚

`snprintf` æ˜¯ C è¯­è¨€ä¸­æœ€é‡è¦ï¼Œæœ€å®‰å…¨çš„å­—ç¬¦ä¸²æ ¼å¼åŒ–å‡½æ•°ä¹‹ä¸€ï¼Œå®ƒå‡ ä¹å®Œå…¨å–ä»£äº†è€çš„ `sprintf`ï¼Œä¹Ÿæ˜¯ç°ä»£ C ä»£ç ä¸­**å”¯ä¸€æ¨èä½¿ç”¨çš„æ ¼å¼åŒ–è¾“å‡ºåˆ°å­—ç¬¦ä¸²çš„å‡½æ•°**ã€‚

MISRA C 2012ï¼ˆæ±½è½¦åµŒå…¥å¼è§„èŒƒï¼‰ï¼š**ç¦æ­¢**ä½¿ç”¨åº“å‡½æ•°`sprintf`ï¼Œ`vsprintf` ï¼Œå¿…é¡»ä½¿ç”¨å¸¦é•¿åº¦é™åˆ¶çš„æ›¿ä»£å‡½æ•°ï¼Œå¦‚`snprintf`ã€`vsnprintf`ã€‚

Linux å†…æ ¸ã€GNUã€LLVMã€Chromeã€Firefox ç­‰å¤§å‹é¡¹ç›®ï¼šå…¨éƒ¨**ç¦æ­¢** `sprintf`ï¼Œå¼ºåˆ¶ `snprintf`ã€‚

é™¤äº†ä¸€äº›å¤§å‹é¡¹ç›®å¯èƒ½è¿˜å­˜åœ¨å†å²é—ç•™çš„`sprintf()`è°ƒç”¨é—®é¢˜ã€‚åœ¨ç°åœ¨çš„æ–°é¡¹ç›®ä¸­ï¼Œç»å¯¹åº”è¯¥ä½¿ç”¨`snprintf`è€Œä¸æ˜¯`sprintf` ï¼Œè¿™æ˜¯å·¥ä¸šç•Œçš„å…±è¯†ï¼Œä¸æ˜¯å¯æœ‰å¯æ— çš„é£æ ¼é—®é¢˜ï¼Œè€Œæ˜¯å®‰å…¨é—®é¢˜ã€‚

```C
void log_push(RingBuffer *rb, const char *msg) {
    Log log_entry = {0};
    
    // å¯ä»¥è‡ªåŠ¨å¤„ç† \0 ç»“å°¾ï¼Œé˜²æ­¢ msg è¿‡é•¿å¯¼è‡´çš„è¶Šç•Œè®¿é—®
    snprintf(log_entry.data, LOG_MSG_SIZE, "%s", msg);
        
    rb_push(rb, &log_entry);
}
```

# 5. æ€§èƒ½å‹æµ‹ä¸æ€»ç»“

ä¸ºäº†éªŒè¯è¿™ä¸ªå¼‚æ­¥æ—¥å¿—åº“çš„å¥å£®æ€§ï¼Œæˆ‘è®¾è®¡äº†ä¸€ä¸ª**é«˜å¹¶å‘ + æå°ç¼“å†²åŒº**çš„æµ‹è¯•åœºæ™¯ã€‚

## 5.1 å‹æµ‹åœºæ™¯è®¾è®¡

ä¸ºäº†æ¨¡æ‹Ÿæœ€æ¶åŠ£çš„ç«äº‰ç¯å¢ƒï¼Œæˆ‘ç‰¹æ„å°†ç¼“å†²åŒºå®¹é‡è®¾ç½®å¾—æå°ï¼Œå¼ºè¿«çº¿ç¨‹**é¢‘ç¹å‘ç”Ÿé˜»å¡å’Œå”¤é†’**ã€‚

ç”Ÿäº§è€…ï¼š2ä¸ªçº¿ç¨‹ï¼ˆProducer1ï¼ŒProducer2ï¼‰ï¼Œæ¯ä¸ªç‹‚å‘1000æ¡æ—¥å¿—ã€‚

æ¶ˆè´¹è€…ï¼š1ä¸ªåå°çº¿ç¨‹ã€‚

ç¼“å†²åŒºå®¹é‡ï¼šè®¾ä¸º10ï¼Œè¿™æ„å‘³ç€ç”Ÿäº§è€…æ¯ç”Ÿäº§å‡ æ¡æ—¥å¿—å°±è¦è¢«è¿«ç¡è§‰ï¼Œé”ç«äº‰å°†ä¼šéå¸¸æ¿€çƒˆã€‚

é¢„æœŸç»“æœï¼šæ—¥å¿—æ–‡ä»¶åº”è¯¥åŒ…å«æ•´æ•´2000æ¡æ•°æ®ï¼Œæ— ä¸¢å¤±ï¼Œæ— ä¹±åºï¼ˆçº¿ç¨‹å†…éƒ¨æœ‰åºï¼‰ï¼Œå¹¶ä¸”ç¨‹åºå¯ä»¥ä¼˜é›…é€€å‡ºã€‚

è¿™æ˜¯ main.c çš„å†…å®¹ï¼Œå¤§å®¶å¯ä»¥ç…§ç€æˆ‘ä¸Šé¢çš„è§£é‡Šæ¢³ç†ä¸€ä¸‹é€»è¾‘:

```C
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <pthread.h>
#include <unistd.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include "ring_buffer.h"

#define FILE_NAME "log.txt"

void log_push(RingBuffer *rb,const char *msg)
{
	Log log_entry = {0};

	snprintf(log_entry.data,LOG_MSG_SIZE,"%s",msg);//æœ€æ¨èçš„å‡½æ•°
		
	rb_push(rb,&log_entry);
}

void *pthread_producer1(void *arg)
{
	RingBuffer *rb = (RingBuffer *)arg;

	for(int i=0;i<1000;i++)
	{
		char buf[64];

		snprintf(buf, sizeof(buf), "Producer1 code:%d\n", i);

		printf("Producer1 pushing:%s\n",buf);

		log_push(rb,buf);

		usleep(100);
	}
	return NULL;
}

void *pthread_producer2(void *arg)
{
	RingBuffer *rb = (RingBuffer *)arg;

	for(int i=0;i<1000;i++)
	{
		char buf[64];

		snprintf(buf, sizeof(buf), "Producer2 code:%d\n", i);

		printf("Producer2 pushing:%s\n",buf);

		log_push(rb,buf);

		usleep(100);
	}
	return NULL;
}

void *pthread_consumer(void *arg)
{
	RingBuffer *rb = (RingBuffer *)arg;
	Log entry;
	while(rb_pop(rb,&entry))//å¾ªç¯æ£€æµ‹è¿”å›å€¼ï¼Œçœ‹çœ‹æ˜¯ä¸æ˜¯è¦é€€å‡º
	{
		write(rb->file_fd,entry.data,strlen(entry.data));
	}
	printf("æ¶ˆè´¹è€…çº¿ç¨‹ï¼šä¼˜é›…é€€å‡º\n");
	return NULL;
}

int main()
{
	RingBuffer rb;

	rb_init(&rb,10);

	rb.file_fd = open(FILE_NAME,O_RDWR|O_CREAT|O_APPEND,0644);
	if(rb.file_fd == -1)
	{
		perror("æ–‡ä»¶æ‰“å¼€å¤±è´¥");
		return -1;
	}

	pthread_t consumer,producer1,producer2;
	pthread_create(&consumer,NULL,pthread_consumer,(void *)&rb);
	pthread_create(&producer1,NULL,pthread_producer1,(void *)&rb);
	pthread_create(&producer2,NULL,pthread_producer2,(void *)&rb);

	pthread_join(producer1,NULL);
	pthread_join(producer2,NULL);
	printf("æ‰€æœ‰ç”Ÿäº§è€…å·²ç»ç»“æŸä»»åŠ¡\n");

	rb_stop(&rb);
	pthread_join(consumer,NULL);
	printf("æ¶ˆè´¹è€…å·²ç»é€€å‡º\n");

	close(rb.file_fd);
	rb_destroy(&rb);
    
	return 0;
}
```

ç”±äºç¯‡å¹…å·²ç»æ¯”è¾ƒé•¿äº†ï¼Œä¸‹é¢æˆ‘ç›´æ¥è´´å‡º Makefile ï¼š

```makefile
CC = gcc
CFLAGS = -Wall -g -pthread

TARGET = app
SRCS = main.c ring_buffer.c
OBJS = $(SRCS:.c=.o)

all: $(TARGET)

$(TARGET): $(OBJS)
	$(CC) $(CFLAGS) -o $(TARGET) $(OBJS)

%.o: %.c ring_buffer.h
	$(CC) $(CFLAGS) -c $< -o $@


.PHONY: clean test

clean:
	rm -f $(OBJS) $(TARGET) log.txt

test: $(TARGET)
	./$(TARGET)

```

ç®€å•ä»‹ç»ä¸€ä¸‹æ€ä¹ˆä½¿ç”¨ï¼Œé¦–å…ˆå‘½ä»¤è¡Œè¾“å…¥makeè¿›è¡Œç¼–è¯‘ï¼Œç„¶åè¾“å…¥./appè¿è¡Œç¨‹åºã€‚æˆ–è€…å«Œéº»çƒ¦çš„å¯ä»¥ç›´æ¥å‘½ä»¤è¡Œè¾“å…¥make testï¼Œè¿™ä¼šç›´æ¥ç¼–è¯‘å¹¶ä¸”è¿è¡Œç¨‹åºã€‚è¿è¡Œå®Œæˆåå¯ä»¥ä½¿ç”¨make cleanæ¸…é™¤ç¨‹åºè¿è¡Œäº§ç”Ÿçš„æ–‡ä»¶ã€‚

## 5.2 æµ‹è¯•ç»“æœéªŒè¯

è¿è¡Œä¹‹åç»ˆç«¯è¾“å‡ºå¦‚ä¸‹ï¼š

![ç»ˆç«¯è¿è¡Œç»“æœ1](C:\Users\xlp\Desktop\å›¾ç‰‡å­˜æ”¾\ç»ˆç«¯è¿è¡Œç»“æœ1.png)

![ç»ˆç«¯è¿è¡Œç»“æœ2](C:\Users\xlp\Desktop\å›¾ç‰‡å­˜æ”¾\ç»ˆç«¯è¿è¡Œç»“æœ2.png)

ç”±äºæˆ‘åœ¨ä¸¤ä¸ªç”Ÿäº§è€…ä¸­éƒ½æ·»åŠ äº†`printf`å‡½æ•°ï¼Œæ‰€ä»¥åœ¨ç»ˆç«¯ä¼šçœ‹åˆ°ä»–ä»¬æ‰“å°å‡ºæ¥çš„å†…å®¹ï¼Œæ€»å…±2000æ¡ï¼Œæˆ‘åªæˆªå›¾äº†æœ€å‰é¢å’Œæœ€åé¢çš„éƒ¨åˆ†ï¼Œå¯ä»¥çœ‹åˆ°å·²ç»**å®ç°äº†ä¼˜é›…é€€å‡º**ï¼ˆç”Ÿäº§è€…å…¨éƒ¨é€€å‡ºåï¼Œæ¶ˆè´¹è€…è‡ªåŠ¨é€€å‡ºï¼‰ã€‚

ç„¶åæˆ‘ä»¬å†æ¥æŸ¥çœ‹ä¸€ä¸‹æ—¥å¿—å†…å®¹æ˜¯å¦å­˜æ”¾åˆ°äº† log.txt é‡Œé¢ï¼š

![log.txtå‰é¢](C:\Users\xlp\Desktop\å›¾ç‰‡å­˜æ”¾\log.txtå‰é¢.png)

![log.txtåé¢](C:\Users\xlp\Desktop\å›¾ç‰‡å­˜æ”¾\log.txtåé¢.png)

æˆ‘ä»¬åŒæ ·åªæˆªå»æœ€å‰é¢å’Œæœ€åé¢çš„éƒ¨åˆ†ï¼Œä¸¤ä¸ªç”Ÿäº§è€…çº¿ç¨‹äº§ç”Ÿçš„æ—¥å¿—å†…å®¹éƒ½æ˜¯ä»0-999ï¼Œä¹Ÿå°±æ˜¯å„1000ä¸ªï¼Œæ€»å…±2000ä¸ªã€‚

![æ—¥å¿—è¡Œæ•°](C:\Users\xlp\Desktop\å›¾ç‰‡å­˜æ”¾\æ—¥å¿—è¡Œæ•°.png)

å†æ¥æŸ¥çœ‹ log.txt æ–‡ä»¶çš„è¡Œæ•°ï¼Œå‘ç°ä¹Ÿæ˜¯2000è¡Œã€‚è¿™è¶³ä»¥è¯´æ˜**ä¸€æ¡æ—¥å¿—éƒ½æ²¡æœ‰ä¸¢å¤±**ã€‚

ç»“æœåˆ†æï¼šåœ¨å®¹é‡ä»…ä¸º 10 çš„æƒ…å†µä¸‹ï¼Œ2000 æ¡æ—¥å¿—å…¨éƒ¨è½ç›˜ï¼Œè¯æ˜**æ¡ä»¶å˜é‡çš„ `wait` & `signal` é€»è¾‘**å¾ˆä¸¥å¯†ã€‚ä¸»çº¿ç¨‹æˆåŠŸç­‰å¾…æ‰€æœ‰å­çº¿ç¨‹ç»“æŸï¼Œè¯æ˜**ä¼˜é›…é€€å‡º**æœºåˆ¶ç”Ÿæ•ˆï¼Œæ²¡æœ‰çº¿ç¨‹å¡åœ¨ `wait` çŠ¶æ€ã€‚ä»ç»ˆç«¯è¾“å‡ºå¯ä»¥çœ‹åˆ°ï¼Œä¸¤ä¸ªç”Ÿäº§è€…**äº¤æ›¿æŠ¢å **æ—¶é—´ç‰‡ï¼Œè¯æ˜**äº’æ–¥é”**æœ‰æ•ˆä¿æŠ¤äº†ä¸´ç•ŒåŒºã€‚

## 5.3 é¡¹ç›®æ€»ç»“ä¸æ€è€ƒ

ä»æœ€å¼€å§‹ç®€å•çš„æ¯äº§ç”Ÿä¸€æ¡æ—¥å¿—å°±ç”¨ `write` ç›´æ¥å†™ç›˜ï¼Œåˆ°æœ€ç»ˆå®Œæˆè¿™ä¸ª**å¼‚æ­¥æ—¥å¿—åº“**ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸ä»…ä»…æ˜¯ä»£ç é‡çš„å¢åŠ ï¼Œæ›´æ˜¯**å·¥ç¨‹æ€ç»´**çš„æå‡ã€‚ä¸‹é¢æ˜¯æˆ‘åœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­çš„ä¸€äº›æ€è€ƒï¼š

### 5.3.1 å‘ç¡¬ä»¶ç‰©ç†ç‰¹æ€§å¦¥å

æœ‰äººå¯èƒ½æ›´å…³æ³¨ç®—æ³•çš„æ—¶é—´å¤æ‚åº¦ï¼Œä½†åœ¨åµŒå…¥å¼åº•å±‚å¼€å‘ä¸­ï¼Œ**ç¡¬ä»¶ç‰¹æ€§**æ‰æ˜¯æ€§èƒ½çš„å¤©èŠ±æ¿ã€‚

æ”¾å¼ƒé“¾è¡¨é€‰æ‹© **Ring Buffer**ï¼Œä¸ä»…ä»…æ˜¯ä¸ºäº†ç®¡ç†æ–¹ä¾¿ï¼Œæ›´æ˜¯ä¸ºäº†**ç¡®å®šæ€§**ã€‚åœ¨é•¿æœŸè¿è¡Œçš„åµŒå…¥å¼ç³»ç»Ÿä¸­ï¼Œé¿å…é¢‘ç¹ `malloc/free` é€ æˆçš„å †å†…å­˜ç¢ç‰‡æ˜¯ç³»ç»Ÿç¨³å®šçš„åŸºçŸ³ã€‚

åˆ©ç”¨æ•°ç»„çš„**ç©ºé—´å±€éƒ¨æ€§**ï¼Œå¤§å¹…å‡å°‘ **Cache Miss**ï¼Œè®© CPU æµæ°´çº¿è·‘å¾—æ›´é¡ºç•…ã€‚

### 5.3.2 è§£è€¦ä¸å‰Šå³°å¡«è°·

åˆ©ç”¨ **ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹ **ï¼Œå°†ä¸šåŠ¡é€»è¾‘ï¼ˆå¿«ï¼‰ä¸ç£ç›˜ I/Oï¼ˆæ…¢ï¼‰å½»åº•åˆ†ç¦»ã€‚

`Ring Buffer` åœ¨è¿™é‡Œæ‰®æ¼”äº†â€œè“„æ°´æ± â€çš„è§’è‰²ã€‚é¢å¯¹çªå‘æµé‡ï¼Œç¼“å†²åŒºèƒ½èµ·åˆ°**å‰Šå³°å¡«è°·**çš„ä½œç”¨ï¼Œé˜²æ­¢ç¬é—´çš„é«˜é¢‘ I/O è¯·æ±‚å°†ç³»ç»Ÿæ‹–å®ã€‚

è™½ç„¶ä½¿ç”¨äº†äº’æ–¥é”ï¼Œä½†é…åˆ**æ¡ä»¶å˜é‡** é¿å…äº†å¿™ç­‰å¾…ï¼Œåœ¨ä¿è¯æ•°æ®å®‰å…¨çš„åŒæ—¶ï¼Œæœ€å¤§ç¨‹åº¦é™ä½äº† CPU å ç”¨ç‡ã€‚

### 5.3.3 é˜²å¾¡æ€§ç¼–ç¨‹ä¸ç”Ÿå‘½å‘¨æœŸ

å…¨é¢ç¦ç”¨ `strcpy/sprintf`ï¼Œä¸¥æ ¼ä½¿ç”¨ `snprintf` é˜²æ­¢ç¼“å†²åŒºæº¢å‡ºã€‚

å®ç°äº†**ä¼˜é›…é€€å‡º** æœºåˆ¶ã€‚é€šè¿‡ `is_running` æ ‡å¿—ä½å’Œå¹¿æ’­å”¤é†’ï¼Œç¡®ä¿ç¨‹åºé€€å‡ºæ—¶ï¼Œç¼“å†²åŒºå†…æ®‹ç•™çš„æ—¥å¿—èƒ½è¢«**å…¨éƒ¨æ¶ˆè´¹**ï¼Œåšåˆ°æ•°æ®é›¶ä¸¢å¤±ã€‚

é€šè¿‡ç»“æ„ä½“å°è£…æ–‡ä»¶æè¿°ç¬¦ä¸äº’æ–¥é”å’Œæ¡ä»¶å˜é‡ï¼Œå®ç°äº†é«˜å†…èšä½è€¦åˆï¼Œæ‹’ç»å…¨å±€å˜é‡çš„æ±¡æŸ“ã€‚

## 5.4 è¿›é˜¶ä¼˜åŒ–æ–¹å‘

è™½ç„¶ç›®å‰çš„ç‰ˆæœ¬å·²ç»æ˜¯ä¸€ä¸ª**ç¨³å®šã€é«˜æ•ˆ**çš„å¼‚æ­¥æ—¥å¿—åº“ï¼Œä½†åœ¨é¢å¯¹æ›´è‹›åˆ»çš„å·¥ä¸šçº§åœºæ™¯ï¼ˆå¦‚è½¦è§„çº§åµŒå…¥å¼ã€é«˜é¢‘äº¤æ˜“ç³»ç»Ÿï¼‰æ—¶ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä»ä»¥ä¸‹å‡ ä¸ªç»´åº¦è¿›è¡Œæ·±åº¦ä¼˜åŒ–ï¼š

### 5.4.1 æ‰¹é‡å†™å…¥ä¸é¡µç¼“å­˜å¯¹é½

å‰é¢å·²ç»æåˆ°æ‰¹é‡å†™å…¥çš„å†…å®¹ï¼Œå¦‚æœé‡‡ç”¨æ‰¹é‡å†™å…¥ï¼Œè¿˜èƒ½åœ¨æœ¬é¡¹ç›®çš„åŸºç¡€ä¸ŠæŠŠ**æ€§èƒ½è¿›ä¸€æ­¥å‹æ¦¨**ã€‚è€Œç›®å‰çš„å®ç°æ˜¯æ¶ˆè´¹è€…æ¯æ¬¡ `Pop` ä¸€æ¡æ—¥å¿—å°±è°ƒç”¨ä¸€æ¬¡ `write` ã€‚

è€Œ `write` æ˜¯ç³»ç»Ÿè°ƒç”¨ï¼Œæ¶‰åŠ**ç”¨æˆ·æ€åˆ°å†…æ ¸æ€çš„ä¸Šä¸‹æ–‡åˆ‡æ¢**ï¼Œå­˜åœ¨ç€å·¨å¤§çš„å¼€é”€ã€‚

ä¼˜åŒ–æ€è·¯ï¼šåœ¨æ¶ˆè´¹è€…çº¿ç¨‹å†…éƒ¨ç»´æŠ¤ä¸€ä¸ª **4KBï¼ˆä¸€é¡µå†…å­˜ï¼‰** çš„ä¸­é—´ç¼“å†²åŒºã€‚å½“ç§¯æ”’çš„æ•°æ®è¾¾åˆ° 4KB æˆ–è€…è¶…æ—¶ï¼ˆå¯ä»¥è‡ªå·±è®¾å®šä¸€ä¸ªæ—¶é—´ï¼‰æ—¶ï¼Œå†ä¸€æ¬¡æ€§è°ƒç”¨ `write` è½ç›˜ã€‚è¿™èƒ½å°†ç³»ç»Ÿè°ƒç”¨çš„é¢‘ç‡é™ä½ä¸€ä¸ªæ•°é‡çº§ï¼Œå¹¶æ›´å¥½åœ°åˆ©ç”¨æ–‡ä»¶ç³»ç»Ÿçš„ **Page Cache**ã€‚

### 5.4.2 å­˜å‚¨ç®¡ç†

åµŒå…¥å¼è®¾å¤‡çš„å­˜å‚¨ç©ºé—´ï¼ˆFlash/SDå¡ï¼‰æ˜¯æœ‰é™çš„ï¼Œæˆ‘ä»¬ä¸èƒ½è®© log.txt æ— é™å¢é•¿ã€‚

ä¼˜åŒ–æ€è·¯ï¼šå½“ log.txt è¾¾åˆ° 10MB æ—¶ï¼Œè‡ªåŠ¨å°†å…¶é‡å‘½åä¸º log.txt.1ï¼Œå¹¶åˆ›å»ºæ–°çš„ log.txtã€‚å¯ä»¥ä¿ç•™æœ€è¿‘ N ä¸ªå¤‡ä»½ï¼Œè‡ªåŠ¨åˆ é™¤æœ€æ—§çš„æ—¥å¿—ï¼Œé˜²æ­¢ç£ç›˜å†™æ»¡å¯¼è‡´ç³»ç»Ÿå´©æºƒã€‚

### 5.4.3 æ— é”é˜Ÿåˆ—

ç›®å‰çš„å®ç°ä½¿ç”¨äº† `Mutex` + `Cond`ã€‚åœ¨æé«˜å¹¶å‘ï¼ˆå‡ åä¸ªçº¿ç¨‹åŒæ—¶å†™å…¥ï¼‰ä¸‹ï¼Œé”ç«äº‰ä¼šå¯¼è‡´ CPU ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€å¢å¤§ã€‚

ä¼˜åŒ–æ€è·¯ï¼šå‚è€ƒ Linux å†…æ ¸ **kfifo** çš„å®ç°ï¼Œåˆ©ç”¨ **åŸå­æ“ä½œ** å’Œ **å†…å­˜å±éšœ ** æ¥ç®¡ç† head å’Œ tail æŒ‡é’ˆã€‚æœ€ç»ˆç›®æ ‡æ˜¯å®ç°**å•ç”Ÿäº§è€…-å•æ¶ˆè´¹è€…**æ¨¡å¼ä¸‹çš„å®Œå…¨æ— é”ï¼Œæˆ–**å¤šç”Ÿäº§è€…**æ¨¡å¼ä¸‹çš„æ— é”å…¥é˜Ÿï¼Œå°†æ€§èƒ½å‹æ¦¨åˆ°ç‰©ç†æé™ã€‚

### 5.4.4 é›¶æ‹·è´

å½“å‰çš„ `log_push` æ¶‰åŠä¸¤æ¬¡æ‹·è´ï¼ˆ`snprintf` åˆ°æ ˆï¼Œ`memcpy` åˆ° `RingBuffer`ï¼‰ã€‚

ä¼˜åŒ–æ€è·¯ï¼šè®¾è®¡å‡½æ•°æ¥å£å…è®¸ä¸šåŠ¡çº¿ç¨‹ç›´æ¥åœ¨ RingBuffer çš„å†…å­˜åŒºåŸŸå†…è¿›è¡Œæ ¼å¼åŒ–å†™å…¥ï¼ˆé€šè¿‡è¿”å›å†™æŒ‡é’ˆï¼‰ï¼Œçœå»ä¸­é—´çš„æ ˆå†…å­˜æ‹·è´è¿‡ç¨‹ï¼Œè¿›ä¸€æ­¥é™ä½å†…å­˜å¸¦å®½å ç”¨ã€‚







